<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>基金行情</title>
<style>
    /* 基础样式保持原有 */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: system-ui, -apple-system, sans-serif;
    }
    :root {
        --primary: #8AB4F8;
        --light: #f5f9ff;
        --gray: #e5e7eb;
        --text: #111111;
        --sub-text: #666;
        --buy: #059669;
        --buy-bg: #ecfdf5;
        --sell: #dc2629;
        --sell-bg: #fee2e2;
        --gray-text: #999;
        --time-bg: #f0f7ff;
    }
    body {
        background: var(--light);
        color: var(--text);
        padding-bottom: 50px;
    }
    .right-center-time {
        position: fixed;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        color: var(--sub-text);
        background: var(--time-bg);
        padding: 6px 10px;
        border-radius: 12px;
        z-index: 888;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .tab-bar {
        display: flex; gap: 8px; padding: 10px 12px;
        background: #fff; border-bottom: 1px solid var(--gray);
        overflow-x: auto; white-space: nowrap;
    }
    .tab {
        padding: 6px 12px; border-radius: 16px;
        font-size: 14px; background: var(--light); cursor: pointer;
    }
    .tab.active { background: var(--primary); color: #fff; }
    .sort-bar {
        display: flex;
        background: #fff;
        border-bottom: 1px solid var(--gray);
    }
    .sort-btn {
        flex: 1;
        padding: 10px 0;
        font-size: 14px;
        background: #fff;
        border: none;
        border-right: 1px solid var(--gray);
        cursor: pointer;
        color: var(--sub-text);
    }
    .sort-btn:last-child { border-right: none; }
    .sort-btn.active {
        background: var(--primary);
        color: #fff;
    }
    .sort-arrow { margin-left: 4px; }
    .container { padding: 8px; }
    .fund-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; overflow: hidden;
    }
    .fund-info {
        width: 90px; padding: 10px; border-right: 1px solid var(--gray);
        display: flex; flex-direction: column; gap: 6px;
    }
    .fund-name {
        font-size: 13px; background: var(--light); padding: 4px;
        border-radius: 4px; text-align: center;
    }
    .fund-code {
        font-size: 12px; color: var(--sub-text); text-align: center;
        cursor: pointer;
        padding: 2px 4px; border-radius: 4px;
        background: #f5f5f5;
    }
    .fund-btns { display: flex; flex-direction: column; gap: 4px; }
    .fund-btns button {
        border: none; border-radius: 4px; font-size: 12px;
        padding: 4px; cursor: pointer;
    }
    .btn-buy { background: var(--buy-bg); color: var(--buy); }
    .btn-sell { background: var(--sell-bg); color: var(--sell); }
    .data-box { flex: 1; overflow-x: auto; }
    .data-row {
        display: inline-flex; align-items: center; height: 100%;
        padding: 0 12px; gap: 16px;
    }
    .data-item {
        min-width: 60px; display: flex; flex-direction: column;
        align-items: center; gap: 4px; padding: 6px 0; border-radius: 6px;
    }
    .data-label { font-size: 11px; color: var(--sub-text); }
    .data-value { font-size: 14px; font-weight: 600; }
    .text-red { color: var(--sell); }
    .text-green { color: var(--buy); }
    .text-gray { color: var(--gray-text); }
    .tip { font-size: 11px; text-align: center; line-height: 1.2; margin-top: 2px; }
    .tip-buy { color: var(--buy); }
    .tip-sell { color: var(--sell); }
    .tip-record { color: var(--primary); font-weight: 500; }
    .bg-sell { background: var(--sell-bg); }
    .bg-buy { background: var(--buy-bg); }
    .footer {
        position: fixed; bottom: 0; left: 0; right: 0; height: 48px;
        background: #fff; border-top: 1px solid var(--gray); display: flex; z-index: 999;
    }
    .footer button {
        flex: 1; height: 100%; border: none; background: none;
        font-size: 14px; color: var(--primary); cursor: pointer;
    }
    .mask {
        position: fixed; inset: 0; background: rgba(0,0,0,0.4);
        display: none; align-items: center; justify-content: center;
        z-index: 9999;
    }
    .modal {
        background: #fff; width: 90%; max-width: 380px; border-radius: 16px; padding: 20px;
        display: flex; flex-direction: column; gap: 14px;
        max-height: 80vh; overflow-y: auto;
    }
    .modal-title { text-align: center; font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .form-item {
        display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .form-item label { font-size: 14px; min-width: 120px; }
    .form-item input, .form-item select, .form-item textarea {
        flex: 1; border: 1px solid var(--gray); border-radius: 6px;
        padding: 6px 8px; font-size: 14px;
    }
    .modal-btn {
        border: none; border-radius: 8px; padding: 8px 12px;
        font-size: 14px; cursor: pointer;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-default { background: var(--gray); color: var(--text); }
    .btn-danger {
        background: var(--sell-bg); color: var(--sell);
        font-size: 12px; padding: 2px 6px; border: none; border-radius: 3px; cursor: pointer;
    }
    .list-box {
        max-height: 100px; overflow-y: auto;
        border: 1px solid var(--gray); border-radius: 6px; padding: 4px;
    }
    .list-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 4px 6px; font-size: 13px;
    }
    .switch {
        width: 40px; height: 20px; background: #ccc;
        border-radius: 10px; position: relative; cursor: pointer;
    }
    .switch::after {
        content: ''; position: absolute; width: 16px; height: 16px;
        background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s;
    }
    .switch.on { background: var(--primary); }
    .switch.on::after { left: 22px; }
    .loading {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9); padding: 12px 24px; border-radius: 8px;
        font-size: 14px; z-index: 99999; display: none;
    }

    /* 全屏检测结果弹窗 */
    .fullscreen-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        z-index: 99999;
        display: none;
        padding: 20px;
        box-sizing: border-box;
    }
    .fullscreen-modal-content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    #fullscreenResult {
        flex: 1;
        overflow-y: auto;
        font-size: 14px;
        white-space: pre-wrap;
        line-height: 1.5;
    }
</style>
</head>
<body>

<!-- 全屏检测结果弹窗 -->
<div class="fullscreen-modal" id="fullscreenModal">
    <div class="fullscreen-modal-content">
        <div id="fullscreenResult"></div>
        <button class="modal-btn btn-default" onclick="closeFullscreenModal()">关闭</button>
    </div>
</div>

<div class="right-center-time" id="rightCenterTime">最近查询: -</div>

<div class="tab-bar" id="tabBar"></div>
<div class="sort-bar">
    <button class="sort-btn active" data-key="today">今日 <span class="sort-arrow">↓</span></button>
    <button class="sort-btn" data-key="3d">3日 <span class="sort-arrow"></span></button>
    <button class="sort-btn" data-key="7d">7日 <span class="sort-arrow"></span></button>
    <button class="sort-btn" data-key="30d">1月 <span class="sort-arrow"></span></button>
</div>
<div class="container" id="container"></div>
<div class="loading" id="loadingTip">加载中...</div>
<div class="footer">
    <button onclick="scrollToToday()">今日</button>
    <button onclick="refreshData()">刷新</button>
    <button onclick="openMoreSettings()">更多设置</button>
</div>

<div class="mask" id="moreSettingsMask">
    <div class="modal">
        <div class="modal-title">更多设置</div>
        <div class="form-item">
            <label>累计修改次数:</label>
            <span id="modifyCount">0</span>
        </div>
        <div class="form-item">
            <label>最近修改时间:</label>
            <span id="lastModifyTime">-</span>
        </div>
        <button class="modal-btn btn-primary" onclick="openAddData()">添加数据</button>
        <button class="modal-btn btn-primary" onclick="openFundSettings()">基金涨跌幅设置</button>
        <button class="modal-btn btn-primary" onclick="openApiSettings()">接口设置</button>
        <button class="modal-btn btn-default" onclick="closeMoreSettings()">关闭</button>
    </div>
</div>

<div class="mask" id="fundSettingsMask">
    <div class="modal">
        <div class="modal-title">基金涨跌幅设置</div>
        <div class="form-item">
            <label>展示历史天数</label>
            <input type="number" id="showDay" value="33">
        </div>
        <div class="form-item">
            <label>卖出阈值 %</label>
            <input type="number" step="0.01" id="sellLine" value="2">
        </div>
        <div class="form-item">
            <label>买入阈值 %</label>
            <input type="number" step="0.01" id="buyLine" value="2">
        </div>
        <div class="form-item">
            <label>多日涨幅提示</label>
            <div class="switch on" id="tipRise"></div>
        </div>
        <div class="form-item">
            <label>多日跌幅提示</label>
            <div class="switch on" id="tipFall"></div>
        </div>
        <div class="form-item">
            <label>定投阈值 %</label>
            <input type="number" step="0.01" id="investPercent" value="2">
        </div>
        <div class="form-item">
            <label>定投金额</label>
            <input type="number" id="investAmount" value="28">
        </div>
        <button class="modal-btn btn-primary" onclick="saveFundSettings()">保存</button>
        <button class="modal-btn btn-default" onclick="closeFundSettings()">关闭</button>
    </div>
</div>

<div class="mask" id="addDataMask">
    <div class="modal">
        <div class="modal-title">添加数据</div>
        <div class="form-item">
            <label>输入板块名</label>
            <input type="text" id="newPlate" placeholder="板块名称">
        </div>
        <button class="modal-btn btn-primary" onclick="addPlate()">创建板块</button>
        <div class="list-box" id="plateList"></div>
        <div class="form-item">
            <label>选择板块</label>
            <select id="selPlate"></select>
        </div>
        <div class="list-box" id="fundList"></div>
        <div class="form-item">
            <label>基金代码</label>
            <input type="text" id="fundCode" placeholder="6位代码">
        </div>
        <button class="modal-btn btn-primary" onclick="addFund()">添加基金</button>
        <div class="form-item">
            <label>批量导入</label>
            <textarea id="batchText" placeholder="板块名+基金代码 换行"></textarea>
        </div>
        <button class="modal-btn btn-primary" onclick="batchImport()">批量导入</button>
        <button class="modal-btn btn-default" onclick="closeAddData()">关闭</button>
    </div>
</div>

<div class="mask" id="apiSettingsMask">
    <div class="modal">
        <div class="modal-title">接口设置</div>
        <div class="form-item">
            <label>实时估值接口重试次数</label>
            <input type="number" id="retryGz" value="3" min="0">
        </div>
        <div class="form-item">
            <label>估值接口超时时间（秒）</label>
            <input type="number" id="timeoutGz" value="5" min="1">
        </div>
        <div class="form-item">
            <label>历史净值接口重试次数</label>
            <input type="number" id="retryLs" value="3" min="0">
        </div>
        <div style="height:1px;background:var(--gray);margin:8px 0"></div>
        <div class="form-item">
            <label>接口获取数据失败默认显示基金名</label>
            <input type="text" id="failName" value="获取失败">
        </div>
        <div class="form-item">
            <label>历史净值涨跌幅获取失败默认值</label>
            <input type="number" id="failRate" value="9876543210">
        </div>
        <div style="height:1px;background:var(--gray);margin:8px 0"></div>
        <!-- 实时估值接口测试 -->
        <div class="form-item">
            <label>检测实时估值接口</label>
            <input type="text" id="testGzCode" placeholder="6位基金代码" value="019244">
        </div>
        <button class="modal-btn btn-primary" onclick="testGzApi()">检测</button>
        <!-- 历史净值接口测试 -->
        <div class="form-item">
            <label>检测历史净值接口</label>
            <input type="text" id="testLsCode" placeholder="6位基金代码">
        </div>
        <button class="modal-btn btn-primary" onclick="testLsApi()">检测</button>
        <button class="modal-btn btn-primary" onclick="checkAndFixHistory()">补充历史净值数据</button>
        <button class="modal-btn btn-primary" onclick="saveApiAndFailSettings()">保存全部</button>
        <button class="modal-btn btn-default" onclick="closeApiSettings()">关闭</button>
    </div>
</div>

<script>
const CONFIG = "FUND_CONFIG";
const PLATES = "FUND_PLATES";
const HISTORY_CACHE = "HISTORY_CACHE";
const FUND_RECORDS = "FUND_RECORDS";
const FAIL_SETTINGS = "FAIL_SETTINGS";
const API_SETTINGS = "API_SETTINGS";
const FIRST_INIT = "FUND_FIRST_INIT";
const MODIFY_LOG = "FUND_MODIFY_LOG";

const DEFAULT_FAIL_VALUE = 9876543210;
const DEFAULT_FAIL_NAME = "获取失败";

const defaultConfig = {
    showDay: 33,
    sellLine: 2,
    buyLine: 2,
    tipRise: true,
    tipFall: true,
    investPercent: 2,
    investAmount: 28
};
const defaultApi = {
    retryGz: 3,
    timeoutGz: 5,
    retryLs: 3
};
const defaultFail = {
    name: DEFAULT_FAIL_NAME,
    rate: DEFAULT_FAIL_VALUE
};
const defaultModifyLog = {
    count: 0,
    lastModifyTime: "",
    lastQueryTime: ""
};

let fundTempData = { today: {}, history: [], loading: false };
let currentTab = "all";
let currentSort = "today";
let sortOrder = "desc";

// 全屏弹窗控制
function openFullscreenModal() {
    document.getElementById("fullscreenModal").style.display = "block";
}
function closeFullscreenModal() {
    document.getElementById("fullscreenModal").style.display = "none";
}

// 修改日志
function getModifyLog() {
    try { return JSON.parse(localStorage.getItem(MODIFY_LOG)) || defaultModifyLog; }
    catch (e) { setModifyLog(defaultModifyLog); return defaultModifyLog; }
}
function setModifyLog(log) { localStorage.setItem(MODIFY_LOG, JSON.stringify(log)); }

// 初始化
function initDefaultCache() {
    if (localStorage.getItem(FIRST_INIT)!== "true") {
        setConfig(defaultConfig);
        setApi(defaultApi);
        setFailSettings(defaultFail);
        setModifyLog(defaultModifyLog);
        localStorage.setItem(FIRST_INIT, "true");
    }
    updateModifyLog();
}

function getConfig() {
    try { return JSON.parse(localStorage.getItem(CONFIG)) || defaultConfig; }
    catch (e) { setConfig(defaultConfig); return defaultConfig; }
}
function setConfig(c) { localStorage.setItem(CONFIG, JSON.stringify(c)); }

function getApi() {
    try { return JSON.parse(localStorage.getItem(API_SETTINGS)) || defaultApi; }
    catch (e) { setApi(defaultApi); return defaultApi; }
}
function setApi(a) { localStorage.setItem(API_SETTINGS, JSON.stringify(a)); }

function getPlates() {
    try { return JSON.parse(localStorage.getItem(PLATES)) || []; }
    catch (e) { return []; }
}
function setPlates(p) { localStorage.setItem(PLATES, JSON.stringify(p)); }

function getHistoryCache() {
    try { return JSON.parse(localStorage.getItem(HISTORY_CACHE)) || {}; }
    catch (e) { return {}; }
}
function setHistoryCache(c) { localStorage.setItem(HISTORY_CACHE, JSON.stringify(c)); }

function getFailSettings() {
    try { return JSON.parse(localStorage.getItem(FAIL_SETTINGS)) || defaultFail; }
    catch (e) { setFailSettings(defaultFail); return defaultFail; }
}
function setFailSettings(f) { localStorage.setItem(FAIL_SETTINGS, JSON.stringify(f)); }

function getRecords() {
    try { return JSON.parse(localStorage.getItem(FUND_RECORDS)) || {}; }
    catch (e) { return {}; }
}
function saveRecord(code, date, type) {
    const r = getRecords();
    if (!r[code]) r[code] = {};
    r[code][date] = type;
    localStorage.setItem(FUND_RECORDS, JSON.stringify(r));
}

function getDateKey(n) {
    const d = new Date();
    d.setDate(d.getDate() - n);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2, '0');
    const ds = String(d.getDate()).padStart(2, '0');
    return `${y}${m}${ds}`;
}

function getTodayDate() {
    return new Date().toISOString().split("T")[0];
}

// 时间格式化
function getNowTime() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const h = String(d.getHours()).padStart(2, '0');
    const i = String(d.getMinutes()).padStart(2, '0');
    const s = String(d.getSeconds()).padStart(2, '0');
    return `${y}-${m}-${day} ${h}:${i}:${s}`;
}

// 更新修改次数+时间
function updateModifyLog() {
    const log = getModifyLog();
    log.count++;
    log.lastModifyTime = getNowTime();
    setModifyLog(log);
    updateLogDisplay();
}

// 更新查询时间
function updateQueryTime() {
    const log = getModifyLog();
    log.lastQueryTime = getNowTime();
    setModifyLog(log);
    updateLogDisplay();
}

// 刷新显示
function updateLogDisplay() {
    const log = getModifyLog();
    document.getElementById("rightCenterTime").innerText = `最近查询: ${log.lastQueryTime || '-'}`;
    document.getElementById("modifyCount").innerText = log.count;
    document.getElementById("lastModifyTime").innerText = log.lastModifyTime || '-';
}

function showLoading(text) {
    document.getElementById("loadingTip").innerText = text || "加载中...";
    document.getElementById("loadingTip").style.display = "block";
}
function hideLoading() {
    document.getElementById("loadingTip").style.display = "none";
}

function removeScript(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
}

async function delay(ms) {
    return new Promise(r => setTimeout(r, ms));
}

// 带超时的重试
async function retryWithTimeout(fn, maxRetry) {
    const api = getApi();
    const timeoutMs = api.timeoutGz * 1000;
    let cnt = 0;
    while (cnt <= maxRetry) {
        const timeoutPromise = new Promise(resolve => setTimeout(() => resolve(false), timeoutMs));
        try {
            const ok = await Promise.race([fn(), timeoutPromise]);
            if (ok) return true;
        } catch (e) {}
        cnt++;
        await delay(800);
    }
    return false;
}

// 复制基金代码
function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        alert("已复制基金代码：" + code);
    }).catch(() => {
        alert("复制失败");
    });
}

// 实时估值接口测试（所有信息显示到提示框）
async function testGzApi() {
    const code = document.getElementById("testGzCode").value.trim();
    if (!/^\d{6}$/.test(code)) {
        alert("请输入6位基金代码");
        return;
    }

    // 打开全屏弹窗，初始化内容
    const resultEl = document.getElementById("fullscreenResult");
    const apiUrl = `https://fundgz.1234567.com.cn/js/${code}.js?_=${new Date().getTime()}`;
    resultEl.innerHTML = "=== 开始检测实时估值接口 ===\n";
    resultEl.innerHTML += `检测时间：${getNowTime()}\n`;
    resultEl.innerHTML += `基金代码：${code}\n\n`;
    resultEl.innerHTML += `【请求信息】\n`;
    resultEl.innerHTML += `请求方式：GET（前端脚本请求）\n`;
    resultEl.innerHTML += `请求地址：${apiUrl}\n`;
    resultEl.innerHTML += `请求头：User-Agent=${navigator.userAgent}\n`;
    resultEl.innerHTML += `请求状态：加载中...\n\n`;
    openFullscreenModal();

    // 记录开始时间
    const startTime = Date.now();

    try {
        // 尝试获取数据
        const fetchRes = await fetch(apiUrl, {
            method: "GET",
            mode: "cors",
            cache: "no-cache"
        });
        const rawData = await fetchRes.text();
        
        // 展示请求结果
        resultEl.innerHTML += `【请求结果】\n`;
        resultEl.innerHTML += `耗时：${Date.now() - startTime}ms\n`;
        resultEl.innerHTML += `HTTP状态码：${fetchRes.status}（${fetchRes.statusText}）\n`;
        resultEl.innerHTML += `响应头：\n`;
        fetchRes.headers.forEach((val, key) => {
            resultEl.innerHTML += `  ${key}: ${val}\n`;
        });
        resultEl.innerHTML += `\n【原始数据】\n${rawData}\n\n`;

        // 解析数据
        try {
            const jsonMatch = rawData.match(/(\{.*\})/);
            if (jsonMatch && jsonMatch[1]) {
                const fundData = JSON.parse(jsonMatch[1]);
                resultEl.innerHTML += `【解析后基金信息】\n`;
                resultEl.innerHTML += `名称：${fundData.name || '未知'}\n`;
                resultEl.innerHTML += `实时估值涨跌幅：${fundData.gszzl || '0'}%\n`;
                resultEl.innerHTML += `单位净值：${fundData.dwjz || '未知'}\n`;
                resultEl.innerHTML += `估算净值：${fundData.gsz || '未知'}\n`;
                resultEl.innerHTML += `更新时间：${fundData.gztime || '未知'}\n`;
            } else {
                resultEl.innerHTML += `【解析失败】\n原始数据格式不符合JSON要求\n`;
            }
        } catch (parseErr) {
            resultEl.innerHTML += `【解析失败】\n错误信息：${parseErr.message}\n`;
        }

    } catch (fetchErr) {
        // 展示失败信息
        resultEl.innerHTML += `【请求失败】\n`;
        resultEl.innerHTML += `耗时：${Date.now() - startTime}ms\n`;
        resultEl.innerHTML += `错误类型：${fetchErr.name}\n`;
        resultEl.innerHTML += `错误信息：${fetchErr.message}\n\n`;
        resultEl.innerHTML += `【手动验证建议】\n`;
        resultEl.innerHTML += `1. 直接在浏览器地址栏访问：${apiUrl}\n`;
        resultEl.innerHTML += `2. 若能访问，复制返回的原始数据到下方：\n`;
        resultEl.innerHTML += `（示例格式：jsonpgz({"fundcode":"019244","name":"xxx"})）\n`;
    } finally {
        resultEl.innerHTML += `\n=== 检测结束 ===`;
    }
}

// 历史净值接口测试
async function testLsApi() {
    const code = document.getElementById("testLsCode").value.trim();
    if (!/^\d{6}$/.test(code)) {
        alert("请输入6位代码");
        return;
    }
    showLoading("检测中...");
    
    let result = null;
    await new Promise(resolve => {
        const s = document.createElement("script");
        s.id = "ls_test";
        s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
        s.onload = () => {
            result = window.fundinfo || null;
            delete window.fundinfo;
            removeScript(s.id);
            resolve();
        };
        s.onerror = () => {
            removeScript(s.id);
            resolve();
        };
        document.body.appendChild(s);
    });
    
    hideLoading();
    if (result) {
        alert(`检测成功：\n基金名：${result.name}\n最新净值：${result.LSJZList[0]?.DWJZ || '未知'}`);
    } else {
        alert("检测失败：接口无响应");
    }
}

// 天天基金JSONP接口（正常获取估值）
window._ttjjCallbacks = {};
function requestGz(code) {
    return new Promise(resolve => {
        removeScript("gz_" + code);
        window._ttjjCallbacks[code] = resolve;
        const s = document.createElement("script");
        s.id = "gz_" + code;
        s.src = `https://fundgz.1234567.com.cn/js/${code}.js?callback=_ttjjCallbacks.${code}&_=${Date.now()}`;
        s.onerror = () => {
            window._ttjjCallbacks[code]?.(false);
            delete window._ttjjCallbacks[code];
        };
        document.body.appendChild(s);
    });
}

// JSONP回调（正常估值请求）
window.jsonpgz = res => {
    if (!res?.fundcode) return;
    const cb = window._ttjjCallbacks[res.fundcode];
    if (cb) {
        const fail = getFailSettings();
        fundTempData.today[res.fundcode] = {
            val: Number(res.gszzl || 0),
            text: (res.gszzl || 0).toFixed(2) + "%",
            cls: res.gszzl >= 0 ? "text-red" : "text-green",
            name: res.name || fail.name
        };
        cb(true);
        delete window._ttjjCallbacks[res.fundcode];
    }
};

// 获取今日估值
async function getTodayData(funds) {
    fundTempData.today = {};
    if (funds.length === 0) return;
    
    const api = getApi();
    const fail = getFailSettings();
    const tasks = funds.map(code => {
        return retryWithTimeout(async () => {
            const success = await requestGz(code);
            if (success) return true;
            fundTempData.today[code] = {
                val: fail.rate,
                text: "失败",
                cls: "text-gray",
                name: fail.name
            };
            return false;
        }, api.retryGz);
    });
    await Promise.all(tasks);
}

// 历史净值接口
async function loadOneHistory(code) {
    return new Promise(resolve => {
        const s = document.createElement("script");
        s.id = "ls_" + code;
        s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
        s.onload = () => {
            try {
                const fi = window.fundinfo;
                if (!fi ||!fi.LSJZList?.length) throw new Error();
                
                const cache = getHistoryCache();
                const days = getConfig().showDay;
                fi.LSJZList.slice(0, days).forEach(item => {
                    const key = item.FSRQ.replace(/-/g, "");
                    if (!cache[key]) cache[key] = {};
                    cache[key][code] = {
                        val: Number(item.JZZZL || 0),
                        text: (item.JZZZL || 0).toFixed(2) + "%",
                        cls: item.JZZZL >= 0 ? "text-red" : "text-green",
                        date: item.FSRQ
                    };
                });
                setHistoryCache(cache);
                resolve(true);
            } catch (e) {
                resolve(false);
            } finally {
                delete window.fundinfo;
                removeScript(s.id);
            }
        };
        s.onerror = () => {
            removeScript(s.id);
            resolve(false);
        };
        document.body.appendChild(s);
    });
}

async function batchLoadHistory(codes) {
    const batch = 3;
    let ok = 0, fail = 0;
    for (let i = 0; i < codes.length; i += batch) {
        const group = codes.slice(i, i + batch);
        const res = await Promise.all(group.map(c => loadOneHistory(c)));
        res.forEach(r => r ? ok++ : fail++);
        await delay(1500);
    }
    alert(`成功：${ok} 只，失败：${fail} 只`);
}

async function checkAndFixHistory() {
    closeApiSettings();
    showLoading("检查历史净值...");
    const all = [...new Set(getPlates().flatMap(p => p.funds).filter(Boolean))];
    await batchLoadHistory(all);
    hideLoading();
    render();
}

// 计算累计涨幅
function calcTotal(code, n) {
    const cache = getHistoryCache();
    const fail = getFailSettings();
    let sum = 0;
    for (let i = 1; i <= n; i++) {
        const key = getDateKey(i);
        const val = cache[key]?.[code]?.val;
        if (val != null && val !== fail.rate) sum += val;
    }
    return Math.round(sum * 100)/100;
}

// 拉取全部数据
async function fetchAll() {
    if (fundTempData.loading) return;
    fundTempData.loading = true;
    showLoading();
    const cfg = getConfig();
    const all = [...new Set(getPlates().flatMap(p => p.funds).filter(Boolean))];
    
    try {
        await getTodayData(all);
        fundTempData.history = [];
        const cache = getHistoryCache();
        const show = Math.min(cfg.showDay, 60);
        for (let i = 1; i <= show; i++) {
            fundTempData.history.push(cache[getDateKey(i)] || {});
        }
        updateQueryTime();
    } catch (e) {
        console.error("拉取失败：", e);
    }
    
    fundTempData.loading = false;
    hideLoading();
    render();
}

// 渲染页面
function render() {
    const cfg = getConfig();
    const fail = getFailSettings();
    const records = getRecords();
    const today = getTodayDate();
    const container = document.getElementById("container");
    let funds = [];
    
    if (currentTab === "all") {
        funds = [...new Set(getPlates().flatMap(p => p.funds).filter(Boolean))];
    } else {
        funds = getPlates()[currentTab]?.funds || [];
    }
    
    if (funds.length === 0) {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--gray-text)">暂无基金</div>`;
        return;
    }
    
    let list = funds.map(code => {
        const td = fundTempData.today[code] || { val: fail.rate, text: "失败", cls: "text-gray", name: fail.name };
        return {
            code,
            name: td.name,
            today: td.val,
            "3d": calcTotal(code, 3),
            "7d": calcTotal(code, 7),
            "30d": calcTotal(code, 30),
            todayData: td,
            todayOperate: records[code]?.[today] || "",
            historyData: fundTempData.history.map(h => h[code] || { val: fail.rate, text: "无数据", cls: "text-gray", date: "" })
        };
    });
    
    list.sort((a, b) => {
        const va = a[currentSort] ?? 0;
        const vb = b[currentSort] ?? 0;
        return sortOrder === "desc" ? vb - va : va - vb;
    });
    
    let html = "";
    list.forEach(item => {
        let operateTip = "";
        if (item.todayOperate === "buy") operateTip = `<span class="tip tip-record">曾买入</span>`;
        if (item.todayOperate === "sell") operateTip = `<span class="tip tip-record">曾卖出</span>`;
        
        let tipHtml = "";
        const val = item.today;
        if (val !== fail.rate) {
            if (val >= cfg.sellLine) tipHtml = `<span class="tip tip-sell">卖(${cfg.sellLine}%)</span>`;
            if (val <= -cfg.buyLine) tipHtml = `<span class="tip tip-buy">买(${cfg.buyLine}%)</span>`;
        }
        
        html += `
        <div class="fund-card">
            <div class="fund-info">
                <div class="fund-name">${item.name}</div>
                <div class="fund-code" onclick="copyCode('${item.code}')">${item.code}</div>
                <div class="fund-btns">
                    <button class="btn-buy" onclick="doBuy('${item.code}')">买入</button>
                    <button class="btn-sell" onclick="doSell('${item.code}')">卖出</button>
                </div>
            </div>
            <div class="data-box">
                <div class="data-row">
                    <div class="data-item">
                        <span class="data-label">今日</span>
                        <span class="${item.todayData.cls} data-value">${item.todayData.text}</span>
                        ${operateTip}${tipHtml}
                    </div>`;
        
        item.historyData.forEach((h, i) => {
            let txt = h.text;
            let cls = h.cls;
            if (h.val === fail.rate) {
                txt = "无数据";
                cls = "text-gray";
            }
            html += `
                    <div class="data-item">
                        <span class="data-label">T-${i+1}</span>
                        <span class="${cls} data-value">${txt}</span>
                    </div>`;
        });
        
        html += `</div></div></div>`;
    });
    
    container.innerHTML = html;
}

// 买入卖出记录
function doBuy(code) {
    saveRecord(code, getTodayDate(), "buy");
    alert("已记录买入");
    render();
}
function doSell(code) {
    saveRecord(code, getTodayDate(), "sell");
    alert("已记录卖出");
    render();
}

function scrollToToday() {
    document.querySelectorAll(".data-box").forEach(b => b.scrollTo({ left: 0 }));
}
function refreshData() {
    fetchAll();
}

// 标签栏
function renderTabs() {
    const bar = document.getElementById("tabBar");
    bar.innerHTML = `<div class="tab ${currentTab === 'all'? 'active' : ''}" onclick="switchTab('all')">全部</div>`;
    getPlates().forEach((p, i) => {
        bar.innerHTML += `<div class="tab ${currentTab === i? 'active' : ''}" onclick="switchTab(${i})">${p.name}</div>`;
    });
}
function switchTab(k) {
    currentTab = k;
    renderTabs();
    render();
}

// 排序
document.querySelectorAll(".sort-btn").forEach(btn => {
    btn.onclick = () => {
        const key = btn.dataset.key;
        if (currentSort === key) {
            sortOrder = sortOrder === "desc"? "asc" : "desc";
        } else {
            currentSort = key;
            sortOrder = "desc";
        }
        document.querySelectorAll(".sort-btn").forEach(b => {
            b.classList.remove("active");
            b.querySelector(".sort-arrow").innerText = "";
        });
        btn.classList.add("active");
        btn.querySelector(".sort-arrow").innerText = sortOrder === "desc"? "↓" : "↑";
        render();
    };
});

// 开关绑定
function bindSwitch() {
    document.querySelectorAll(".switch").forEach(sw => {
        sw.onclick = () => sw.classList.toggle("on");
    });
}

// 弹窗操作
function openMoreSettings() {
    updateLogDisplay();
    document.getElementById("moreSettingsMask").style.display = "flex";
}
function closeMoreSettings() {
    document.getElementById("moreSettingsMask").style.display = "none";
}

function openFundSettings() {
    const c = getConfig();
    document.getElementById("showDay").value = c.showDay;
    document.getElementById("sellLine").value = c.sellLine;
    document.getElementById("buyLine").value = c.buyLine;
    document.getElementById("tipRise").classList.toggle("on", c.tipRise);
    document.getElementById("tipFall").classList.toggle("on", c.tipFall);
    document.getElementById("investPercent").value = c.investPercent;
    document.getElementById("investAmount").value = c.investAmount;
    document.getElementById("fundSettingsMask").style.display = "flex";
}
function closeFundSettings() { document.getElementById("fundSettingsMask").style.display = "none"; }

function saveFundSettings() {
    const c = {
        showDay: parseInt(document.getElementById("showDay").value) || 33,
        sellLine: parseFloat(document.getElementById("sellLine").value) || 2,
        buyLine: parseFloat(document.getElementById("buyLine").value) || 2,
        tipRise: document.getElementById("tipRise").classList.contains("on"),
        tipFall: document.getElementById("tipFall").classList.contains("on"),
        investPercent: parseFloat(document.getElementById("investPercent").value) || 2,
        investAmount: parseInt(document.getElementById("investAmount").value) || 28
    };
    setConfig(c);
    closeFundSettings();
    updateModifyLog();
    fetchAll();
}

function openApiSettings() {
    const a = getApi();
    const f = getFailSettings();
    document.getElementById("retryGz").value = a.retryGz;
    document.getElementById("timeoutGz").value = a.timeoutGz;
    document.getElementById("retryLs").value = a.retryLs;
    document.getElementById("failName").value = f.name;
    document.getElementById("failRate").value = f.rate;
    document.getElementById("apiSettingsMask").style.display = "flex";
}
function closeApiSettings() { document.getElementById("apiSettingsMask").style.display = "none"; }

function saveApiAndFailSettings() {
    setApi({
        retryGz: parseInt(document.getElementById("retryGz").value) || 3,
        timeoutGz: parseInt(document.getElementById("timeoutGz").value) || 5,
        retryLs: parseInt(document.getElementById("retryLs").value) || 3
    });
    setFailSettings({
        name: document.getElementById("failName").value.trim() || DEFAULT_FAIL_NAME,
        rate: parseFloat(document.getElementById("failRate").value) || DEFAULT_FAIL_VALUE
    });
    closeApiSettings();
    updateModifyLog();
    fetchAll();
}

// 增删板块基金
function openAddData() {
    renderPlateList();
    document.getElementById("addDataMask").style.display = "flex";
}
function closeAddData() { document.getElementById("addDataMask").style.display = "none"; }

function renderPlateList() {
    const p = getPlates();
    let html = "";
    p.forEach((item, i) => {
        html += `<div class="list-item"><span>${item.name}（${item.funds.length}）</span><button class="btn-danger" onclick="deletePlate(${i})">删</button></div>`;
    });
    document.getElementById("plateList").innerHTML = html || "<div class='list-item'><span>暂无板块</span></div>";
    renderSelectPlate();
}
function renderSelectPlate() {
    const p = getPlates();
    let html = `<option value="">--选择板块--</option>`;
    p.forEach((item, i) => html += `<option value="${i}">${item.name}</option>`);
    document.getElementById("selPlate").innerHTML = html;
    renderFundList();
}
function renderFundList() {
    const p = getPlates();
    const idx = document.getElementById("selPlate").value;
    const box = document.getElementById("fundList");
    if (!idx ||!p[idx]) {
        box.innerHTML = "<div class='list-item'><span>请选板块</span></div>";
        return;
    }
    const funds = p[idx].funds;
    let html = "";
    funds.forEach((code, i) => {
        html += `<div class="list-item"><span>${code}</span><button class="btn-danger" onclick="deleteFund(${idx},${i})">删</button></div>`;
    });
    box.innerHTML = html || "<div class='list-item'><span>暂无基金</span></div>";
}

function addPlate() {
    const name = document.getElementById("newPlate").value.trim();
    if (!name) return alert("请输入板块名");
    const p = getPlates();
    if (p.some(x => x.name === name)) return alert("已存在");
    p.push({ name, funds: [] });
    setPlates(p);
    document.getElementById("newPlate").value = "";
    renderPlateList();
    renderTabs();
    updateModifyLog();
}
function deletePlate(i) {
    if (!confirm("确定删除？")) return;
    const p = getPlates();
    p.splice(i, 1);
    setPlates(p);
    renderPlateList();
    renderTabs();
    fetchAll();
    updateModifyLog();
}

function addFund() {
    const idx = document.getElementById("selPlate").value;
    const code = document.getElementById("fundCode").value.trim();
    if (!idx) return alert("请选板块");
    if (!/^\d{6}$/.test(code)) return alert("请输入6位代码");
    const p = getPlates();
    if (p[idx].funds.includes(code)) return alert("已存在");
    p[idx].funds.push(code);
    setPlates(p);
    document.getElementById("fundCode").value = "";
    renderFundList();
    fetchAll();
    updateModifyLog();
}
function deleteFund(pIdx, fIdx) {
    if (!confirm("确定删除？")) return;
    const p = getPlates();
    p[pIdx].funds.splice(fIdx, 1);
    setPlates(p);
    renderFundList();
    fetchAll();
    updateModifyLog();
}

function batchImport() {
    const text = document.getElementById("batchText").value.trim();
    if (!text) return alert("请输入内容");
    const lines = text.split("\n").map(x => x.trim()).filter(Boolean);
    const p = getPlates();
    let current = null;
    lines.forEach(line => {
        if (/^\d{6}$/.test(line)) {
            if (current &&!current.funds.includes(line)) current.funds.push(line);
        } else {
            let find = p.find(x => x.name === line);
            if (!find) {
                find = { name: line, funds: [] };
                p.push(find);
            }
            current = find;
        }
    });
    setPlates(p);
    closeAddData();
    renderTabs();
    fetchAll();
    updateModifyLog();
    alert("导入完成");
}

// 页面加载
window.onload = () => {
    try {
        initDefaultCache();
        bindSwitch();
        renderTabs();
        fetchAll();
        updateLogDisplay();
    } catch (e) {
        console.error("加载失败：", e);
        document.getElementById("container").innerHTML = `<div style="text-align:center;padding:40px;color:var(--sell)">页面加载出错，请刷新重试</div>`;
        hideLoading();
    }
};
</script>
</body>
</html>
