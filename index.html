<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <title>基金行情（支持0天历史）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }
        :root {
            --primary: #8AB4F8;
            --light: #f5f9ff;
            --gray: #e5e7eb;
            --text: #111827;
            --sub-text: #6b7280;
            --buy: #059669;
            --buy-bg: #ecfdf5;
            --sell: #dc2629;
            --sell-bg: #fee2e2;
            --invest: #8B5CF6;
            --invest-bg: #f5f3ff;
            --pink: rgba(255, 228, 235, 0.6);
        }
        body {
            background: var(--light);
            color: var(--text);
            padding-bottom: 50px;
        }
        .top-time {
            position: fixed;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            font-size: 12px;
            color: var(--sub-text);
            background: var(--pink);
            padding: 4px 8px;
            border-radius: 8px;
            opacity: 0.9;
            z-index: 1;
            pointer-events: none;
            white-space: nowrap;
        }
        .header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid var(--gray);
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
        }
        .sort-group {
            display: flex;
            gap: 8px;
        }
        .sort-btn {
            border: 1px solid var(--primary);
            background: #fff;
            color: var(--primary);
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .sort-btn.active {
            background: var(--primary);
            color: #fff;
        }
        .container {
            padding: 8px;
        }
        .plate-title {
            font-size: 14px;
            font-weight: 600;
            padding: 10px 4px;
        }
        .fund-card {
            background: #fff;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .fund-info {
            width: 90px;
            padding: 10px;
            border-right: 1px solid var(--gray);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fund-name {
            font-size: 13px;
            background: var(--light);
            padding: 4px;
            border-radius: 4px;
            text-align: center;
        }
        .fund-code {
            font-size: 12px;
            color: var(--sub-text);
            text-align: center;
        }
        .fund-btns {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .fund-btns button {
            border: none;
            border-radius: 4px;
            font-size: 12px;
            padding: 4px;
            cursor: pointer;
        }
        .btn-buy { background: var(--buy-bg); color: var(--buy); }
        .btn-sell { background: var(--sell-bg); color: var(--sell); }
        .data-box {
            flex: 1;
            overflow-x: auto;
        }
        .data-row {
            display: inline-flex;
            align-items: center;
            height: 100%;
            padding: 0 12px;
            gap: 16px;
        }
        .data-item {
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 0;
            border-radius: 6px;
        }
        .data-label { font-size: 11px; color: var(--sub-text); }
        .data-value { font-size: 14px; font-weight: 600; }
        .text-red { color: var(--sell); }
        .text-green { color: var(--buy); }
        .tip { font-size: 11px; text-align: center; line-height: 1.2; margin-top: 2px; }
        .bg-sell { background: var(--sell-bg); }
        .bg-buy { background: var(--buy-bg); }
        .bg-invest { background: var(--invest-bg); }
        .tip-sell { color: var(--sell); }
        .tip-buy { color: var(--buy); }
        .tip-invest { color: var(--invest) !important; font-weight: 500; }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: #fff;
            border-top: 1px solid var(--gray);
            display: flex;
            align-items: center;
            z-index: 999;
        }
        .footer button {
            flex: 1;
            height: 100%;
            border: none;
            background: none;
            font-size: 14px;
            color: var(--primary);
            cursor: pointer;
        }
        .mask {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal {
            background: #fff;
            width: 88%;
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .modal-title {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .form-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .form-item label { font-size: 14px; width: 100px; }
        .form-item input, .form-item select, .form-item textarea {
            flex: 1;
            border: 1px solid var(--gray);
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 14px;
        }
        .form-item textarea { min-height: 60px; resize: none; }
        .modal-btn {
            border: none;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-default { background: var(--gray); color: var(--text); }
        .btn-danger {
            background: var(--sell-bg);
            color: var(--sell);
            font-size: 12px;
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .list-box {
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid var(--gray);
            border-radius: 6px;
            padding: 4px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
            font-size: 13px;
        }
        .switch {
            width: 40px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
        }
        .switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.2s;
        }
        .switch.on { background: var(--primary); }
        .switch.on::after { left: 22px; }
        /* 加载提示样式 */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            color: var(--text);
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
<div class="top-time" id="timeText"></div>
<!-- 加载提示 -->
<div class="loading" id="loadingTip">加载中...</div>

<div class="header">
    <div class="sort-group">
        <button class="sort-btn" id="globalSort">全局涨跌</button>
        <button class="sort-btn" id="plateSort">板块内涨跌</button>
        <button class="sort-btn" id="orderSort">涨序</button>
    </div>
</div>

<div class="container" id="container"></div>

<!-- 底部按钮：今日=仅滚动；刷新=才请求数据 -->
<div class="footer">
    <button onclick="scrollToToday()">今日</button>
    <button onclick="openSet()">更多操作</button>
    <button onclick="refreshData()">刷新</button>
    <button onclick="openAdd()">添加数据</button>
</div>

<!-- 设置弹窗 -->
<div class="mask" id="setMask">
    <div class="modal">
        <div class="modal-title">更多操作</div>
        <div class="form-item">
            <label>展示历史天数</label>
            <!-- 关键修改：去掉min="1"，支持输入0 -->
            <input type="number" id="showDay" value="3">
        </div>
        <div class="form-item">
            <label>缓存历史数据天数</label>
            <input type="number" id="cacheDay" value="15" min="1">
        </div>
        <div class="form-item">
            <label>卖出阈值 %</label>
            <input type="number" step="0.01" id="sellLine" value="0.1">
        </div>
        <div class="form-item">
            <label>买入阈值 %</label>
            <input type="number" step="0.01" id="buyLine" value="0.1">
        </div>
        <div class="form-item">
            <label>多日涨幅提示</label>
            <div class="switch" id="tipRise"></div>
        </div>
        <div class="form-item">
            <label>多日跌幅提示</label>
            <div class="switch" id="tipFall"></div>
        </div>
        <div class="form-item">
            <label>定投提醒</label>
            <div class="switch" id="tipInvest"></div>
        </div>
        <div class="form-item">
            <label>定投阈值 %</label>
            <input type="number" step="0.01" id="investPercent" value="2">
        </div>
        <div class="form-item">
            <label>定投金额</label>
            <input type="number" id="investAmount" value="999">
        </div>
        <button class="modal-btn btn-primary" onclick="saveSet()">保存</button>
        <button class="modal-btn btn-default" onclick="closeSet()">关闭</button>
    </div>
</div>

<!-- 添加数据弹窗 -->
<div class="mask" id="addMask">
    <div class="modal">
        <div class="modal-title">数据管理</div>
        <div class="form-item">
            <label>输入板块名</label>
            <input type="text" id="newPlate" placeholder="板块名称">
        </div>
        <button class="modal-btn btn-primary" onclick="addPlate()">创建板块</button>
        <div class="list-box" id="plateList"></div>
        <div class="form-item">
            <label>选择板块</label>
            <select id="selPlate"></select>
        </div>
        <div class="list-box" id="fundList"></div>
        <div class="form-item">
            <label>基金代码</label>
            <input type="text" id="fundCode" placeholder="基金代码">
        </div>
        <button class="modal-btn btn-primary" onclick="addFund()">添加基金</button>
        <div class="form-item">
            <label>批量导入</label>
            <textarea id="batchText" placeholder="板块+代码 换行输入"></textarea>
        </div>
        <button class="modal-btn btn-primary" onclick="batchImport()">批量导入</button>
        <button class="modal-btn btn-default" onclick="closeAdd()">关闭</button>
    </div>
</div>

<script>
// 存储KEY常量
const CONFIG = "FUND_CONFIG";
const PLATES = "FUND_PLATES";
const HISTORY_CACHE = "HISTORY_CACHE";
const SORT_TYPE = "SORT_TYPE";
const SORT_ORDER = "SORT_ORDER";

// 临时数据存储（今日+历史数据）
let fundTempData = { today: {}, history: [], loading: false };

// 默认配置（支持showDay=0）
const defaultConfig = {
    showDay: 3, cacheDay: 15, sellLine: 0.1, buyLine: 0.1,
    tipRise: false, tipFall: false, tipInvest: false,
    investPercent: 2, investAmount: 999
};

// ===================== 工具函数 =====================
function showLoading() { document.getElementById("loadingTip").style.display = "block"; }
function hideLoading() { document.getElementById("loadingTip").style.display = "none"; }

// 本地存储读写
function getConfig() {
    try { return JSON.parse(localStorage.getItem(CONFIG)) || { ...defaultConfig }; }
    catch (e) { return { ...defaultConfig }; }
}
function setConfig(c) { localStorage.setItem(CONFIG, JSON.stringify(c)); }

function getPlates() {
    try { return JSON.parse(localStorage.getItem(PLATES)) || []; }
    catch (e) { return []; }
}
function setPlates(p) { localStorage.setItem(PLATES, JSON.stringify(p)); }

function getHistoryCache() {
    try { return JSON.parse(localStorage.getItem(HISTORY_CACHE)) || {}; }
    catch (e) { return {}; }
}
function setHistoryCache(cache) { localStorage.setItem(HISTORY_CACHE, JSON.stringify(cache)); }

// 清理超期缓存
function clearExpireCache() {
    const cfg = getConfig();
    const cache = getHistoryCache();
    const newCache = {};
    Object.keys(cache).forEach(key => {
        if (Number(key) <= cfg.cacheDay) newCache[key] = cache[key];
    });
    setHistoryCache(newCache);
}

// 移除script标签
function removeScript(id) {
    const s = document.getElementById(id);
    if (s) s.remove();
}

// ===================== 接口请求逻辑 =====================
// 1. 今日实时估值
window.jsonpgz = function (res) {
    if (res && res.fundcode) {
        const code = res.fundcode;
        const gszzl = Number(res.gszzl || 0);
        fundTempData.today[code] = {
            val: gszzl,
            text: gszzl.toFixed(2) + "%",
            cls: gszzl >= 0 ? "text-red" : "text-green",
            name: res.name || "未知基金",
            time: res.gztime || new Date().toLocaleTimeString()
        };
    }
};

function getRealTodayData(funds) {
    return new Promise(resolve => {
        fundTempData.today = {};
        const total = funds.length;
        if (total === 0) { resolve(); return; }

        let count = 0;
        funds.forEach(code => {
            removeScript("gz_" + code);
            const s = document.createElement("script");
            s.id = "gz_" + code;
            s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rtime=${Date.now()}`;
            s.onload = () => {
                count++;
                if (count === total) resolve();
            };
            s.onerror = () => {
                count++;
                fundTempData.today[code] = { val: 0, text: "0.00%", cls: "text-red", name: "数据加载失败" };
                if (count === total) resolve();
            };
            document.body.appendChild(s);
        });
    });
}

// 2. 历史净值（showDay=0时不执行）
function getRealHistoryData(code, dayIdx) {
    return new Promise(resolve => {
        const cache = getHistoryCache();
        if (cache[dayIdx] && cache[dayIdx][code]) {
            resolve();
            return;
        }

        const s = document.createElement("script");
        s.id = `ls_${code}_${dayIdx}`;
        s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
        s.onload = function() {
            try {
                const fundInfo = window.fundinfo;
                if (fundInfo && fundInfo.LSJZList && fundInfo.LSJZList.length >= dayIdx) {
                    const item = fundInfo.LSJZList[dayIdx - 1];
                    const jzzzl = Number(item.JZZZL || 0);
                    const cache = getHistoryCache();
                    if (!cache[dayIdx]) cache[dayIdx] = {};
                    cache[dayIdx][code] = {
                        val: jzzzl,
                        text: jzzzl.toFixed(2) + "%",
                        cls: jzzzl >= 0 ? "text-red" : "text-green",
                        date: item.FSRQ || ""
                    };
                    setHistoryCache(cache);
                }
            } catch (e) {}
            resolve();
            removeScript(s.id);
            delete window.fundinfo;
        };
        s.onerror = function() {
            resolve();
            removeScript(s.id);
        };
        document.body.appendChild(s);
    });
}

// 批量拉取历史数据（showDay=0时直接跳过）
async function getAllRealHistory(funds) {
    const cfg = getConfig();
    if (cfg.showDay <= 0) return; // 关键修改：showDay=0时不加载历史数据
    clearExpireCache();
    const cache = getHistoryCache();

    for (let i = 1; i <= cfg.showDay; i++) {
        const needRequestFunds = funds.filter(code => !cache[i] || !cache[i][code]);
        if (needRequestFunds.length === 0) continue;

        await Promise.all(
            needRequestFunds.map(code => getRealHistoryData(code, i))
        );
    }
}

// ===================== 核心逻辑 =====================
async function fetchAllData() {
    if (fundTempData.loading) return;
    fundTempData.loading = true;
    showLoading();

    const cfg = getConfig();
    const plates = getPlates();
    const allFunds = [...new Set(plates.flatMap(p => p.funds).filter(code => code))];

    try {
        // showDay=0时只拉今日数据，不拉历史数据
        if (cfg.showDay <= 0) {
            await getRealTodayData(allFunds);
            fundTempData.history = []; // 清空历史数据
        } else {
            await Promise.all([
                getRealTodayData(allFunds),
                getAllRealHistory(allFunds)
            ]);

            // 按配置的展示天数组装历史数据
            fundTempData.history = [];
            const cache = getHistoryCache();
            for (let i = 1; i <= cfg.showDay; i++) {
                fundTempData.history.push(cache[i] || {});
            }
        }
    } catch (e) {
        console.error("数据加载失败:", e);
    }

    fundTempData.loading = false;
    hideLoading();
    render();
}

// 今日按钮：仅滚动
function scrollToToday() {
    document.querySelectorAll(".data-box").forEach(box => {
        box.scrollTo({ left: 0, behavior: "smooth" });
    });
}

// 刷新按钮：重新拉取数据
function refreshData() {
    const now = new Date().toLocaleString();
    document.getElementById("timeText").textContent = `最后刷新：${now}`;
    fetchAllData();
}

// ===================== 页面渲染 =====================
function render() {
    const cfg = getConfig();
    const originPlates = getPlates();
    const sortType = localStorage.getItem(SORT_TYPE) || "plate";
    const sortOrder = localStorage.getItem(SORT_ORDER) || "desc";
    const container = document.getElementById("container");
    let html = "";

    if (sortType === "global") {
        let allFunds = [];
        originPlates.forEach(plate => {
            plate.funds.forEach(code => {
                const today = fundTempData.today[code] || { val: 0, text: "0.00%", cls: "text-red", name: "未知基金" };
                const history = fundTempData.history.map(h => h[code] || { val: 0, text: "0.00%", cls: "text-red" });
                allFunds.push({ plate: plate.name, code, name: today.name, today, history });
            });
        });
        allFunds.sort((a, b) => sortOrder === "desc" ? b.today.val - a.today.val : a.today.val - b.today.val);
        allFunds.forEach(item => html += renderFundCard(item));
    } else {
        originPlates.forEach(plate => {
            let plateFunds = [];
            plate.funds.forEach(code => {
                const today = fundTempData.today[code] || { val: 0, text: "0.00%", cls: "text-red", name: "未知基金" };
                const history = fundTempData.history.map(h => h[code] || { val: 0, text: "0.00%", cls: "text-red" });
                plateFunds.push({ plate: plate.name, code, name: today.name, today, history });
            });
            plateFunds.sort((a, b) => sortOrder === "desc" ? b.today.val - a.today.val : a.today.val - b.today.val);
            html += `<div class="plate-title">${plate.name}</div>`;
            plateFunds.forEach(item => html += renderFundCard(item));
        });
    }

    container.innerHTML = html;
    renderTips();
    updateSortButtons();
}

function renderFundCard(item) {
    let cardHtml = `
    <div class="fund-card">
        <div class="fund-info">
            <div class="fund-name">${item.name}</div>
            <div class="fund-code">${item.code}</div>
            <div class="fund-btns">
                <button class="btn-buy">买入</button>
                <button class="btn-sell">卖出</button>
            </div>
        </div>
        <div class="data-box">
            <div class="data-row">
                <div class="data-item" data-val="${item.today.val}">
                    <span class="data-label">今日</span>
                    <span class="${item.today.cls} data-value">${item.today.text}</span>
                </div>`;

    // 关键修改：showDay>0时才渲染历史数据
    if (item.history.length > 0) {
        item.history.forEach((h, i) => {
            cardHtml += `
            <div class="data-item">
                <span class="data-label">T-${i+1}</span>
                <span class="${h.cls} data-value">${h.text}</span>
                ${h.date ? `<span class="tip">${h.date}</span>` : ""}
            </div>`;
        });
    }

    cardHtml += `</div></div></div>`;
    return cardHtml;
}

function renderTips() {
    const cfg = getConfig();
    document.querySelectorAll("[data-val]").forEach(el => {
        const val = parseFloat(el.dataset.val);
        el.querySelectorAll(".tip").forEach(t => t.remove());
        el.classList.remove("bg-sell", "bg-buy", "bg-invest");

        if (cfg.sellLine > 0 && val >= cfg.sellLine) {
            const tip = document.createElement("span");
            tip.className = "tip tip-sell";
            tip.textContent = `卖出阈值(${cfg.sellLine}%)`;
            el.appendChild(tip);
            el.classList.add("bg-sell");
        }

        if (cfg.buyLine > 0 && val <= -cfg.buyLine) {
            const tip = document.createElement("span");
            tip.className = "tip tip-buy";
            tip.textContent = `买入阈值(${cfg.buyLine}%)`;
            el.appendChild(tip);
            el.classList.add("bg-buy");

            if (cfg.tipInvest && cfg.investPercent > 0 && val < -cfg.investPercent) {
                const investTip = document.createElement("span");
                investTip.className = "tip tip-invest";
                investTip.textContent = `定投${cfg.investAmount}元`;
                el.appendChild(investTip);
                el.classList.add("bg-invest");
            }
        }
    });
}

function updateSortButtons() {
    const sortType = localStorage.getItem(SORT_TYPE) || "plate";
    const sortOrder = localStorage.getItem(SORT_ORDER) || "desc";
    document.getElementById("globalSort").classList.toggle("active", sortType === "global");
    document.getElementById("plateSort").classList.toggle("active", sortType === "plate");
    document.getElementById("orderSort").textContent = sortOrder === "desc" ? "跌序" : "涨序";
}

// ===================== 弹窗操作 =====================
function bindSwitchButtons() {
    document.querySelectorAll(".switch").forEach(sw => {
        sw.onclick = () => sw.classList.toggle("on");
    });
}

document.getElementById("globalSort").onclick = () => { localStorage.setItem(SORT_TYPE, "global"); render(); };
document.getElementById("plateSort").onclick = () => { localStorage.setItem(SORT_TYPE, "plate"); render(); };
document.getElementById("orderSort").onclick = () => { localStorage.setItem(SORT_ORDER, localStorage.getItem(SORT_ORDER) === "desc" ? "asc" : "desc"); render(); };

function openSet() {
    const cfg = getConfig();
    // 打开弹窗时显示当前配置（包括0）
    document.getElementById("showDay").value = cfg.showDay;
    document.getElementById("cacheDay").value = cfg.cacheDay;
    document.getElementById("sellLine").value = cfg.sellLine;
    document.getElementById("buyLine").value = cfg.buyLine;
    document.getElementById("tipRise").classList.toggle("on", cfg.tipRise);
    document.getElementById("tipFall").classList.toggle("on", cfg.tipFall);
    document.getElementById("tipInvest").classList.toggle("on", cfg.tipInvest);
    document.getElementById("investPercent").value = cfg.investPercent;
    document.getElementById("investAmount").value = cfg.investAmount;
    document.getElementById("setMask").style.display = "flex";
}

function closeSet() { document.getElementById("setMask").style.display = "none"; }

// 保存配置（支持showDay=0）
function saveSet() {
    const newConfig = {
        showDay: parseInt(document.getElementById("showDay").value) || 0, // 关键修改：默认0而非3
        cacheDay: parseInt(document.getElementById("cacheDay").value) || 15,
        sellLine: parseFloat(document.getElementById("sellLine").value) || 0.1,
        buyLine: parseFloat(document.getElementById("buyLine").value) || 0.1,
        tipRise: document.getElementById("tipRise").classList.contains("on"),
        tipFall: document.getElementById("tipFall").classList.contains("on"),
        tipInvest: document.getElementById("tipInvest").classList.contains("on"),
        investPercent: parseFloat(document.getElementById("investPercent").value) || 2,
        investAmount: parseInt(document.getElementById("investAmount").value) || 999
    };
    setConfig(newConfig);
    closeSet();
    fetchAllData(); // 保存后重新拉取数据，确保配置生效
}

function openAdd() {
    renderPlateList();
    document.getElementById("addMask").style.display = "flex";
}

function closeAdd() { document.getElementById("addMask").style.display = "none"; }

function renderPlateList() {
    const plates = getPlates();
    let plateHtml = "";
    plates.forEach((p, i) => {
        plateHtml += `<div class="list-item"><span>${p.name}（${p.funds.length}只）</span><button class="btn-danger" onclick="deletePlate(${i})">删除</button></div>`;
    });
    document.getElementById("plateList").innerHTML = plateHtml || "<div class='list-item'><span>暂无板块</span></div>";
    renderSelectPlate();
}

function renderSelectPlate() {
    const plates = getPlates();
    let selectHtml = `<option value="">--选择板块--</option>`;
    plates.forEach((p, i) => {
        selectHtml += `<option value="${i}">${p.name}</option>`;
    });
    document.getElementById("selPlate").innerHTML = selectHtml;
    renderSelectFund();
}

function renderSelectFund() {
    const plates = getPlates();
    const plateIndex = document.getElementById("selPlate").value;
    const fundListBox = document.getElementById("fundList");

    if (!plateIndex || !plates[plateIndex]) {
        fundListBox.innerHTML = "<div class='list-item'><span>请选择板块</span></div>";
        return;
    }

    const funds = plates[plateIndex].funds;
    let fundHtml = "";
    if (funds.length === 0) {
        fundHtml = "<div class='list-item'><span>暂无基金</span></div>";
    } else {
        funds.forEach((code, i) => {
            fundHtml += `<div class="list-item"><span>${code}</span><button class="btn-danger" onclick="deleteFund(${plateIndex},${i})">删除</button></div>`;
        });
    }
    fundListBox.innerHTML = fundHtml;
}

function addPlate() {
    const plateName = document.getElementById("newPlate").value.trim();
    if (!plateName) { alert("请输入有效的板块名称"); return; }
    const plates = getPlates();
    if (plates.some(p => p.name === plateName)) { alert("该板块已存在"); return; }
    plates.push({ name: plateName, funds: [] });
    setPlates(plates);
    document.getElementById("newPlate").value = "";
    renderPlateList();
}

function deletePlate(index) {
    if (!confirm("确认删除该板块及包含的所有基金？")) return;
    const plates = getPlates();
    plates.splice(index, 1);
    setPlates(plates);
    renderPlateList();
    fetchAllData();
}

function addFund() {
    const plateIndex = document.getElementById("selPlate").value;
    const fundCode = document.getElementById("fundCode").value.trim();
    if (!plateIndex) { alert("请先选择板块"); return; }
    if (!fundCode || !/^\d{6}$/.test(fundCode)) { alert("请输入6位数字的基金代码"); return; }
    const plates = getPlates();
    if (plates[plateIndex].funds.includes(fundCode)) { alert("该基金已在当前板块中"); return; }
    plates[plateIndex].funds.push(fundCode);
    setPlates(plates);
    document.getElementById("fundCode").value = "";
    renderSelectFund();
    fetchAllData();
}

function deleteFund(plateIndex, fundIndex) {
    if (!confirm("确认删除该基金？")) return;
    const plates = getPlates();
    plates[plateIndex].funds.splice(fundIndex, 1);
    setPlates(plates);
    renderSelectFund();
    fetchAllData();
}

function batchImport() {
    const text = document.getElementById("batchText").value.trim();
    if (!text) { alert("请输入导入内容"); return; }
    const lines = text.split("\n").map(line => line.trim()).filter(line => line);
    const plates = getPlates();
    let currentPlate = null;

    lines.forEach(line => {
        if (/^\d{6}$/.test(line)) {
            if (currentPlate && !currentPlate.funds.includes(line)) {
                currentPlate.funds.push(line);
            }
        } else {
            let plate = plates.find(p => p.name === line);
            if (!plate) {
                plate = { name: line, funds: [] };
                plates.push(plate);
            }
            currentPlate = plate;
        }
    });

    setPlates(plates);
    closeAdd();
    fetchAllData();
    alert("批量导入完成");
}

// ===================== 初始化 =====================
window.onload = () => {
    bindSwitchButtons();
    document.getElementById("selPlate").onchange = renderSelectFund;
    fetchAllData();
};
</script>
</body>
</html>
