<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>基金行情</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: system-ui, -apple-system, sans-serif;
    }
    :root {
        --primary: #8AB4F8;
        --light: #f5f9ff;
        --gray: #e5e7eb;
        --text: #111111;
        --sub-text: #666;
        --buy: #059669;
        --buy-bg: #ecfdf5;
        --sell: #dc2629;
        --sell-bg: #fee2e2;
        --gray-text: #999;
        --time-bg: #f0f7ff;
    }
    body {
        background: var(--light);
        color: var(--text);
        padding-bottom: 50px;
    }
    .top-time {
        position: fixed;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        color: var(--sub-text);
        background: var(--time-bg);
        padding: 6px 10px;
        border-radius: 12px;
        z-index: 888;
        white-space: nowrap;
    }
    .tab-bar {
        display: flex; gap: 8px; padding: 10px 12px;
        background: #fff; border-bottom: 1px solid var(--gray);
        overflow-x: auto; white-space: nowrap;
    }
    .tab {
        padding: 6px 12px; border-radius: 16px;
        font-size: 14px; background: var(--light); cursor: pointer;
    }
    .tab.active { background: var(--primary); color: #fff; }
    .sort-bar {
        display: flex;
        background: #fff;
        border-bottom: 1px solid var(--gray);
    }
    .sort-btn {
        flex: 1;
        padding: 10px 0;
        font-size: 14px;
        background: #fff;
        border: none;
        border-right: 1px solid var(--gray);
        cursor: pointer;
        color: var(--sub-text);
    }
    .sort-btn:last-child { border-right: none; }
    .sort-btn.active {
        background: var(--primary);
        color: #fff;
    }
    .sort-arrow { margin-left: 4px; }
    .container { padding: 8px; }
    .fund-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; overflow: hidden;
    }
    .fund-info {
        width: 90px; padding: 10px; border-right: 1px solid var(--gray);
        display: flex; flex-direction: column; gap: 6px;
    }
    .fund-name {
        font-size: 13px; background: var(--light); padding: 4px;
        border-radius: 4px; text-align: center;
    }
    .fund-code {
        font-size: 12px; color: var(--sub-text); text-align: center;
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 4px;
        background: #f5f5f5;
    }
    .fund-btns { display: flex; flex-direction: column; gap: 4px; }
    .fund-btns button {
        border: none; border-radius: 4px; font-size: 12px;
        padding: 4px; cursor: pointer;
    }
    .btn-buy { background: var(--buy-bg); color: var(--buy); }
    .btn-sell { background: var(--sell-bg); color: var(--sell); }
    .data-box { flex: 1; overflow-x: auto; }
    .data-row {
        display: inline-flex; align-items: center; height: 100%;
        padding: 0 12px; gap: 16px;
    }
    .data-item {
        min-width: 60px; display: flex; flex-direction: column;
        align-items: center; gap: 4px; padding: 6px 0; border-radius: 6px;
    }
    .data-label { font-size: 11px; color: var(--sub-text); }
    .data-value { font-size: 14px; font-weight: 600; }
    .text-red { color: var(--sell); }
    .text-green { color: var(--buy); }
    .text-gray { color: var(--gray-text); }
    .tip { font-size: 11px; text-align: center; line-height: 1.2; margin-top: 2px; }
    .tip-buy { color: var(--buy); }
    .tip-sell { color: var(--sell); }
    .tip-record { color: var(--primary); font-weight: 500; }
    .bg-sell { background: var(--sell-bg); }
    .bg-buy { background: var(--buy-bg); }
    .footer {
        position: fixed; bottom: 0; left: 0; right: 0; height: 48px;
        background: #fff; border-top: 1px solid var(--gray); display: flex; z-index: 999;
    }
    .footer button {
        flex: 1; height: 100%; border: none; background: none;
        font-size: 14px; color: var(--primary); cursor: pointer;
    }
    .mask {
        position: fixed; inset: 0; background: rgba(0,0,0,0.4);
        display: none; align-items: center; justify-content: center;
        z-index: 9999;
    }
    .modal {
        background: #fff; width: 90%; max-width: 380px; border-radius: 16px; padding: 20px;
        display: flex; flex-direction: column; gap: 14px;
        max-height: 80vh; overflow-y: auto;
    }
    .modal-title { text-align: center; font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .form-item {
        display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .form-item label { font-size: 14px; min-width: 120px; }
    .form-item input, .form-item select, .form-item textarea {
        flex: 1; border: 1px solid var(--gray); border-radius: 6px;
        padding: 6px 8px; font-size: 14px;
    }
    .form-text {
        width: 100%; height: 120px; resize: none; font-size: 12px;
        white-space: pre; overflow-wrap: normal; overflow-x: auto;
    }
    .modal-btn {
        border: none; border-radius: 8px; padding: 8px 12px;
        font-size: 14px; cursor: pointer;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-default { background: var(--gray); color: var(--text); }
    .btn-danger {
        background: var(--sell-bg); color: var(--sell);
        font-size: 12px; padding: 2px 6px; border: none; border-radius: 3px; cursor: pointer;
    }
    .list-box {
        max-height: 100px; overflow-y: auto;
        border: 1px solid var(--gray); border-radius: 6px; padding: 4px;
    }
    .list-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 4px 6px; font-size: 13px;
    }
    .switch {
        width: 40px; height: 20px; background: #ccc;
        border-radius: 10px; position: relative; cursor: pointer;
    }
    .switch::after {
        content: ''; position: absolute; width: 16px; height: 16px;
        background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s;
    }
    .switch.on { background: var(--primary); }
    .switch.on::after { left: 22px; }
    .loading {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9); padding: 12px 24px; border-radius: 8px;
        font-size: 14px; z-index: 99999; display: none;
    }
</style>
</head>
<body>
<div class="top-time" id="timeText"></div>
<div class="tab-bar" id="tabBar"></div>
<div class="sort-bar">
    <button class="sort-btn active" data-key="today">今日 <span class="sort-arrow">↓</span></button>
    <button class="sort-btn" data-key="3d">3日 <span class="sort-arrow"></span></button>
    <button class="sort-btn" data-key="7d">7日 <span class="sort-arrow"></span></button>
    <button class="sort-btn" data-key="30d">1月 <span class="sort-arrow"></span></button>
</div>
<div class="container" id="container"></div>
<div class="loading" id="loadingTip">加载中...</div>

<div class="footer">
    <button onclick="scrollToToday()">今日</button>
    <button onclick="refreshData()">刷新</button>
    <button onclick="openMoreSettings()">更多设置</button>
</div>

<div class="mask" id="moreSettingsMask">
    <div class="modal">
        <div class="modal-title">更多设置</div>
        <button class="modal-btn btn-primary" onclick="openAddData()">添加数据</button>
        <button class="modal-btn btn-primary" onclick="openFundSettings()">基金涨跌幅设置</button>
        <button class="modal-btn btn-primary" onclick="openApiSettings()">接口设置</button>
        <button class="modal-btn btn-default" onclick="closeMoreSettings()">关闭</button>
    </div>
</div>

<div class="mask" id="fundSettingsMask">
    <div class="modal">
        <div class="modal-title">基金涨跌幅设置</div>
        <div class="form-item">
            <label>展示历史天数</label>
            <input type="number" id="showDay" value="33">
        </div>
        <div class="form-item">
            <label>卖出阈值 %</label>
            <input type="number" step="0.01" id="sellLine" value="2">
        </div>
        <div class="form-item">
            <label>买入阈值 %</label>
            <input type="number" step="0.01" id="buyLine" value="2">
        </div>
        <div class="form-item">
            <label>多日涨幅提示</label>
            <div class="switch on" id="tipRise"></div>
        </div>
        <div class="form-item">
            <label>多日跌幅提示</label>
            <div class="switch on" id="tipFall"></div>
        </div>
        <div class="form-item">
            <label>定投阈值 %</label>
            <input type="number" step="0.01" id="investPercent" value="2">
        </div>
        <div class="form-item">
            <label>定投金额</label>
            <input type="number" id="investAmount" value="28">
        </div>
        <button class="modal-btn btn-primary" onclick="saveFundSettings()">保存</button>
        <button class="modal-btn btn-default" onclick="closeFundSettings()">关闭</button>
    </div>
</div>

<div class="mask" id="addDataMask">
    <div class="modal">
        <div class="modal-title">添加数据</div>
        <div class="form-item">
            <label>输入板块名</label>
            <input type="text" id="newPlate" placeholder="板块名称">
        </div>
        <button class="modal-btn btn-primary" onclick="addPlate()">创建板块</button>
        <div class="list-box" id="plateList"></div>
        <div class="form-item">
            <label>选择板块</label>
            <select id="selPlate"></select>
        </div>
        <div class="list-box" id="fundList"></div>
        <div class="form-item">
            <label>基金代码</label>
            <input type="text" id="fundCode" placeholder="6位代码">
        </div>
        <button class="modal-btn btn-primary" onclick="addFund()">添加基金</button>
        <div class="form-item">
            <label>批量导入</label>
            <textarea id="batchText" placeholder="板块名+基金代码 换行"></textarea>
        </div>
        <button class="modal-btn btn-primary" onclick="batchImport()">批量导入</button>
        <button class="modal-btn btn-default" onclick="closeAddData()">关闭</button>
    </div>
</div>

<div class="mask" id="apiSettingsMask">
    <div class="modal">
        <div class="modal-title">接口设置</div>
        
        <div class="form-item">
            <label>实时估值接口重试次数</label>
            <input type="number" id="retryGz" value="3" min="0">
        </div>
        <div class="form-item">
            <label>历史净值接口重试次数</label>
            <input type="number" id="retryLs" value="3" min="0">
        </div>

        <div style="height:1px;background:var(--gray);margin:8px 0"></div>
        
        <div class="form-item">
            <label>接口获取失败默认基金名</label>
            <input type="text" id="failName" value="狗屁基金">
        </div>
        <div class="form-item">
            <label>失败默认涨跌幅</label>
            <input type="number" id="failRate" value="9876543210">
        </div>

        <div style="height:1px;background:var(--gray);margin:8px 0"></div>

        <div class="form-item">
            <label>检测实时估值接口</label>
            <input type="text" id="testGzCode" placeholder="6位基金代码">
        </div>
        <button class="modal-btn btn-primary" onclick="testGzApi()">检测</button>
        <textarea class="form-text" id="testGzResult" readonly></textarea>

        <div class="form-item">
            <label>检测历史净值接口</label>
            <input type="text" id="testLsCode" placeholder="6位基金代码">
        </div>
        <button class="modal-btn btn-primary" onclick="testLsApi()">检测</button>
        <textarea class="form-text" id="testLsResult" readonly></textarea>

        <button class="modal-btn btn-primary" onclick="checkAndFixHistory()">补充历史净值数据</button>
        
        <button class="modal-btn btn-primary" onclick="saveApiAndFailSettings()">保存全部</button>
        <button class="modal-btn btn-default" onclick="closeApiSettings()">关闭</button>
    </div>
</div>

<script>
const CONFIG = "FUND_CONFIG";
const PLATES = "FUND_PLATES";
const HISTORY_CACHE = "HISTORY_CACHE";
const FUND_RECORDS = "FUND_RECORDS";
const FAIL_SETTINGS = "FAIL_SETTINGS";
const API_SETTINGS = "API_SETTINGS";

const DEFAULT_FAIL_VALUE = 9876543210;
const DEFAULT_FAIL_NAME = "狗屁基金";

let fundTempData = { today: {}, history: [], loading: false };
let currentTab = "all";
let currentSort = "today";
let sortOrder = "desc";

const defaultConfig = {
    showDay: 33,
    sellLine: 2,
    buyLine: 2,
    tipRise: true,
    tipFall: true,
    investPercent: 2,
    investAmount: 28
};

const defaultApi = {
    retryGz: 3,
    retryLs: 3
};

const defaultFail = {
    name: DEFAULT_FAIL_NAME,
    rate: DEFAULT_FAIL_VALUE
};

function getConfig() {
    try { return { ...defaultConfig, ...JSON.parse(localStorage.getItem(CONFIG)) }; }
    catch (e) { return { ...defaultConfig }; }
}
function setConfig(c) { localStorage.setItem(CONFIG, JSON.stringify(c)); }

function getApi() {
    try { return { ...defaultApi, ...JSON.parse(localStorage.getItem(API_SETTINGS)) }; }
    catch (e) { return { ...defaultApi }; }
}
function setApi(a) { localStorage.setItem(API_SETTINGS, JSON.stringify(a)); }

function getPlates() {
    try { return JSON.parse(localStorage.getItem(PLATES)) || []; }
    catch (e) { return []; }
}
function setPlates(p) { localStorage.setItem(PLATES, JSON.stringify(p)); }

function getHistoryCache() {
    try { return JSON.parse(localStorage.getItem(HISTORY_CACHE)) || {}; }
    catch (e) { return {}; }
}
function setHistoryCache(c) { localStorage.setItem(HISTORY_CACHE, JSON.stringify(c)); }

function getFailSettings() {
    try { return { ...defaultFail, ...JSON.parse(localStorage.getItem(FAIL_SETTINGS)) }; }
    catch (e) { return { ...defaultFail }; }
}
function setFailSettings(f) { localStorage.setItem(FAIL_SETTINGS, JSON.stringify(f)); }

function getRecords() {
    try { return JSON.parse(localStorage.getItem(FUND_RECORDS)) || {}; }
    catch (e) { return {}; }
}
function saveRecord(code, date, type) {
    const r = getRecords();
    if (!r[code]) r[code] = {};
    r[code][date] = type;
    localStorage.setItem(FUND_RECORDS, JSON.stringify(r));
}

function getDateKey(n) {
    const d = new Date();
    d.setDate(d.getDate() - n);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const ds = String(d.getDate()).padStart(2, '0');
    return `${y}${m}${ds}`;
}

function showLoading(text) {
    document.getElementById("loadingTip").innerText = text || "加载中...";
    document.getElementById("loadingTip").style.display = "block";
}
function hideLoading() {
    document.getElementById("loadingTip").style.display = "none";
}

function removeScript(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
}

async function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

async function retry(fn, maxRetry) {
    let cnt = 0;
    while (cnt <= maxRetry) {
        try { if(await fn()) return true; } catch(e){}
        cnt++; await delay(800);
    }
    return false;
}

function copyCode(code) {
    navigator.clipboard.writeText(code).then(()=>alert("已复制基金代码："+code)).catch(()=>alert("复制失败"));
}

window.jsonpgz = res => {
    window._testGzRes = res;
    if (!res || !res.fundcode) return;
    const v = Number(res.gszzl || 0);
    const fail = getFailSettings();
    fundTempData.today[res.fundcode] = {
        val: v, text: v.toFixed(2)+"%", cls: v>=0?"text-red":"text-green", name: res.name || fail.name
    };
};

function requestGz(code) {
    return new Promise(resolve => {
        removeScript("gz_"+code);
        const s = document.createElement("script");
        s.id = "gz_"+code;
        s.src = `https://fundgz.1234567.com.cn/js/${code}.js?${Date.now()}`;
        s.onload = ()=>resolve(true);
        s.onerror = ()=>resolve(false);
        document.body.appendChild(s);
    });
}

async function loadGzOnly(code) {
    window._testGzRes = null;
    await requestGz(code);
    await delay(300);
    return window._testGzRes;
}

async function loadLsOnly(code) {
    return new Promise(resolve => {
        removeScript("ls_"+code);
        const s = document.createElement("script");
        s.id = "ls_"+code;
        s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
        s.onload = () => {
            const res = window.fundinfo || null;
            resolve(res);
            delete window.fundinfo;
        };
        s.onerror = ()=>resolve(null);
        document.body.appendChild(s);
    });
}

async function getTodayData(funds) {
    return new Promise(resolve => {
        fundTempData.today = {};
        if(!funds.length) return resolve();
        const api = getApi();
        const fail = getFailSettings();
        let done = 0;
        funds.forEach(code => {
            retry(()=>requestGz(code), api.retryGz).then(ok=>{
                if(!ok || !fundTempData.today[code]){
                    fundTempData.today[code] = {val:fail.rate, text:fail.rate+"", cls:"text-gray", name:fail.name};
                }
                done++;
                if(done === funds.length) resolve();
            });
        });
    });
}

async function loadOneHistory(code) {
    const cfg = getConfig();
    const days = cfg.showDay;
    const api = getApi();
    return retry(()=>{
        return new Promise(async resolve=>{
            try{
                removeScript("ls_"+code);
                const s = document.createElement("script");
                s.id = "ls_"+code;
                s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
                s.onload = ()=>{
                    try{
                        const fi = window.fundinfo;
                        if(!fi || !fi.LSJZList) throw new Error();
                        const list = fi.LSJZList;
                        const cache = getHistoryCache();
                        for(let i=0;i<days&&i<list.length;i++){
                            const item = list[i];
                            const v = Number(item.JZZZL||0);
                            const dt = item.FSRQ;
                            const key = dt.replace(/-/g,"");
                            if(!cache[key]) cache[key] = {};
                            cache[key][code] = {val:v, text:v.toFixed(2)+"%", cls:v>=0?"text-red":"text-green", date:dt};
                        }
                        setHistoryCache(cache);
                        resolve(true);
                    }catch(e){resolve(false);}finally{
                        delete window.fundinfo; removeScript(s.id);
                    }
                };
                s.onerror = ()=>resolve(false);
                document.body.appendChild(s);
            }catch(e){resolve(false);}
        });
    }, api.retryLs);
}

async function batchLoadHistory(codes) {
    const batch = 3;
    let ok=0,fail=0;
    for(let i=0;i<codes.length;i+=batch){
        const g = codes.slice(i,i+batch);
        const r = await Promise.all(g.map(c=>loadOneHistory(c)));
        r.forEach(v=>v?ok++:fail++);
        await delay(1500);
    }
    alert(`成功：${ok} 只，失败：${fail} 只`);
}

async function checkAndFixHistory() {
    closeApiSettings();
    showLoading("检查历史净值...");
    const all = [...new Set(getPlates().flatMap(p=>p.funds).filter(Boolean))];
    await batchLoadHistory(all);
    hideLoading();
    render();
}

function calcTotal(code, n) {
    const cache = getHistoryCache();
    const fail = getFailSettings();
    let sum=0;
    for(let i=1;i<=n;i++){
        const key = getDateKey(i);
        const val = cache[key]?.[code]?.val;
        if(val!=null && val!==fail.rate) sum+=val;
    }
    return Math.round(sum*100)/100;
}

async function fetchAll() {
    if(fundTempData.loading) return;
    fundTempData.loading = true;
    showLoading();
    const cfg = getConfig();
    const all = [...new Set(getPlates().flatMap(p=>p.funds).filter(Boolean))];
    try{
        await getTodayData(all);
        fundTempData.history = [];
        const cache = getHistoryCache();
        const show = Math.min(cfg.showDay,60);
        for(let i=1;i<=show;i++) fundTempData.history.push(cache[getDateKey(i)]||{});
    }catch(e){}
    fundTempData.loading = false;
    hideLoading();
    render();
}

function render() {
    const cfg = getConfig();
    const fail = getFailSettings();
    const container = document.getElementById("container");
    let funds = currentTab==="all"?[...new Set(getPlates().flatMap(p=>p.funds).filter(Boolean))]:(getPlates()[currentTab]?.funds||[]);

    let list = funds.map(code=>{
        const td = fundTempData.today[code] || {val:fail.rate, text:fail.rate+"", cls:"text-gray", name:fail.name};
        return {
            code, name:td.name, today:td.val,
            "3d":calcTotal(code,3), "7d":calcTotal(code,7), "30d":calcTotal(code,30),
            todayData:td,
            historyData:fundTempData.history.map(h=>h[code]||{val:fail.rate, text:fail.rate+"", cls:"text-gray", date:""})
        };
    });

    list.sort((a,b)=>{
        const va=a[currentSort]??0, vb=b[currentSort]??0;
        return sortOrder==="desc"?vb-va:va-vb;
    });

    let html = "";
    list.forEach(item=>{
        html+=`
        <div class="fund-card">
            <div class="fund-info">
                <div class="fund-name">${item.name}</div>
                <div class="fund-code" onclick="copyCode('${item.code}')">${item.code}</div>
                <div class="fund-btns">
                    <button class="btn-buy" onclick="doBuy('${item.code}')">买入</button>
                    <button class="btn-sell" onclick="doSell('${item.code}')">卖出</button>
                </div>
            </div>
            <div class="data-box">
                <div class="data-row">
                    <div class="data-item" data-val="${item.today}">
                        <span class="data-label">今日</span>
                        <span class="${item.todayData.cls} data-value">${item.todayData.text}</span>
                    </div>`;
        item.historyData.forEach((h,i)=>{
            let txt=h.text, cls=h.cls;
            if(h.val===fail.rate){txt="失败";cls="text-gray";}
            html+=`
                    <div class="data-item">
                        <span class="data-label">T-${i+1}</span>
                        <span class="${cls} data-value">${txt}</span>
                    </div>`;
        });
        html+=`</div></div></div>`;
    });
    container.innerHTML = html;
}

function doBuy(code){
    saveRecord(code, new Date().toISOString().split("T")[0], "buy");
    alert("已记录买入");
}
function doSell(code){
    saveRecord(code, new Date().toISOString().split("T")[0], "sell");
    alert("已记录卖出");
}

function scrollToToday(){
    document.querySelectorAll(".data-box").forEach(b=>b.scrollTo({left:0}));
}

function refreshData(){
    document.getElementById("timeText").innerText = new Date().toLocaleString();
    fetchAll();
}

function renderTabs(){
    const bar = document.getElementById("tabBar");
    bar.innerHTML = `<div class="tab ${currentTab==='all'?'active':''}" onclick="switchTab('all')">全部</div>`;
    getPlates().forEach((p,i)=>{
        bar.innerHTML+=`<div class="tab ${currentTab===i?'active':''}" onclick="switchTab(${i})">${p.name}</div>`;
    });
}
function switchTab(k){currentTab=k;renderTabs();render();}

document.querySelectorAll(".sort-btn").forEach(btn=>{
    btn.onclick = ()=>{
        const key=btn.dataset.key;
        if(currentSort===key) sortOrder=sortOrder==="desc"?"asc":"desc";
        else{currentSort=key;sortOrder="desc";}
        document.querySelectorAll(".sort-btn").forEach(b=>{b.classList.remove("active");b.querySelector(".sort-arrow").innerText="";});
        btn.classList.add("active");
        btn.querySelector(".sort-arrow").innerText=sortOrder==="desc"?"↓":"↑";
        render();
    };
});

function bindSwitch(){
    document.querySelectorAll(".switch").forEach(sw=>{sw.onclick=()=>sw.classList.toggle("on");});
}

function openMoreSettings(){document.getElementById("moreSettingsMask").style.display="flex";}
function closeMoreSettings(){document.getElementById("moreSettingsMask").style.display="none";}

function openFundSettings(){
    const c=getConfig();
    document.getElementById("showDay").value=c.showDay;
    document.getElementById("sellLine").value=c.sellLine;
    document.getElementById("buyLine").value=c.buyLine;
    document.getElementById("tipRise").classList.toggle("on",c.tipRise);
    document.getElementById("tipFall").classList.toggle("on",c.tipFall);
    document.getElementById("investPercent").value=c.investPercent;
    document.getElementById("investAmount").value=c.investAmount;
    document.getElementById("fundSettingsMask").style.display="flex";
}
function closeFundSettings(){document.getElementById("fundSettingsMask").style.display="none";}
function saveFundSettings(){
    setConfig({
        showDay:parseInt(document.getElementById("showDay").value)||33,
        sellLine:parseFloat(document.getElementById("sellLine").value)||2,
        buyLine:parseFloat(document.getElementById("buyLine").value)||2,
        tipRise:document.getElementById("tipRise").classList.contains("on"),
        tipFall:document.getElementById("tipFall").classList.contains("on"),
        investPercent:parseFloat(document.getElementById("investPercent").value)||2,
        investAmount:parseInt(document.getElementById("investAmount").value)||28
    });
    closeFundSettings();fetchAll();
}

function openApiSettings(){
    const a=getApi();
    const f=getFailSettings();
    document.getElementById("retryGz").value=a.retryGz;
    document.getElementById("retryLs").value=a.retryLs;
    document.getElementById("failName").value=f.name;
    document.getElementById("failRate").value=f.rate;
    document.getElementById("apiSettingsMask").style.display="flex";
}
function closeApiSettings(){document.getElementById("apiSettingsMask").style.display="none";}
function saveApiAndFailSettings(){
    setApi({
        retryGz:parseInt(document.getElementById("retryGz").value)||3,
        retryLs:parseInt(document.getElementById("retryLs").value)||3
    });
    setFailSettings({
        name:document.getElementById("failName").value.trim()||DEFAULT_FAIL_NAME,
        rate:parseFloat(document.getElementById("failRate").value)||DEFAULT_FAIL_VALUE
    });
    closeApiSettings();fetchAll();
}

async function testGzApi(){
    const code=document.getElementById("testGzCode").value.trim();
    if(!/^\d{6}$/.test(code))return alert("6位代码");
    showLoading("检测估值接口...");
    const res=await loadGzOnly(code);
    hideLoading();
    document.getElementById("testGzResult").value=res?JSON.stringify(res,null,2):"请求失败";
}
async function testLsApi(){
    const code=document.getElementById("testLsCode").value.trim();
    if(!/^\d{6}$/.test(code))return alert("6位代码");
    showLoading("检测净值接口...");
    const res=await loadLsOnly(code);
    hideLoading();
    document.getElementById("testLsResult").value=res?JSON.stringify(res,null,2):"请求失败";
}

function openAddData(){renderPlateList();document.getElementById("addDataMask").style.display="flex";}
function closeAddData(){document.getElementById("addDataMask").style.display="none";}
function renderPlateList(){
    const p=getPlates();
    let html="";
    p.forEach((item,i)=>{
        html+=`<div class="list-item"><span>${item.name}（${item.funds.length}）</span><button class="btn-danger" onclick="deletePlate(${i})">删</button></div>`;
    });
    document.getElementById("plateList").innerHTML=html||"<div class='list-item'><span>暂无板块</span></div>";
    renderSelectPlate();
}
function renderSelectPlate(){
    const p=getPlates();
    let html=`<option value="">--选择板块--</option>`;
    p.forEach((item,i)=>html+=`<option value="${i}">${item.name}</option>`);
    document.getElementById("selPlate").innerHTML=html;
    renderFundList();
}
function renderFundList(){
    const p=getPlates();
    const idx=document.getElementById("selPlate").value;
    const box=document.getElementById("fundList");
    if(!idx||!p[idx]){box.innerHTML="<div class='list-item'><span>请选板块</span></div>";return;}
    const funds=p[idx].funds;
    let html="";
    funds.forEach((code,i)=>{
        html+=`<div class="list-item"><span>${code}</span><button class="btn-danger" onclick="deleteFund(${idx},${i})">删</button></div>`;
    });
    box.innerHTML=html||"<div class='list-item'><span>暂无基金</span></div>";
}
function addPlate(){
    const name=document.getElementById("newPlate").value.trim();
    if(!name)return alert("请输入板块名");
    const p=getPlates();
    if(p.some(x=>x.name===name))return alert("已存在");
    p.push({name,funds:[]});
    setPlates(p);
    document.getElementById("newPlate").value="";
    renderPlateList();renderTabs();
}
function deletePlate(i){
    if(!confirm("确定删除？"))return;
    const p=getPlates();p.splice(i,1);setPlates(p);
    renderPlateList();renderTabs();fetchAll();
}
function addFund(){
    const idx=document.getElementById("selPlate").value;
    const code=document.getElementById("fundCode").value.trim();
    if(!idx)return alert("请选板块");
    if(!/^\d{6}$/.test(code))return alert("6位代码");
    const p=getPlates();
    if(p[idx].funds.includes(code))return alert("已存在");
    p[idx].funds.push(code);setPlates(p);
    document.getElementById("fundCode").value="";
    renderFundList();fetchAll();
}
function deleteFund(pIdx,fIdx){
    if(!confirm("确定删除？"))return;
    const p=getPlates();p[pIdx].funds.splice(fIdx,1);setPlates(p);
    renderFundList();fetchAll();
}
function batchImport(){
    const text=document.getElementById("batchText").value.trim();
    if(!text)return alert("请输入内容");
    const lines=text.split("\n").map(x=>x.trim()).filter(Boolean);
    const p=getPlates();
    let current=null;
    lines.forEach(line=>{
        if(/^\d{6}$/.test(line)){
            if(current&&!current.funds.includes(line))current.funds.push(line);
        }else{
            let find=p.find(x=>x.name===line);
            if(!find){find={name:line,funds:[]};p.push(find);}
            current=find;
        }
    });
    setPlates(p);
    closeAddData();renderTabs();fetchAll();alert("导入完成");
}

window.onload=()=>{bindSwitch();renderTabs();refreshData();};
</script>
</body>
</html>
