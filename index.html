<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>基金行情</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: system-ui, -apple-system, sans-serif;
    }
    :root {
        --primary: #8AB4F8;
        --light: #f5f9ff;
        --gray: #e5e7eb;
        --text: #111111;
        --sub-text: #666;
        --buy: #059669;
        --buy-bg: #ecfdf5;
        --sell: #dc2629;
        --sell-bg: #fee2e2;
        --gray-text: #999;
    }
    body {
        background: var(--light);
        color: var(--text);
        padding-bottom: 60px;
    }
    .top-time {
        position: fixed;
        right: 8px; top: 8px;
        font-size: 12px; color: var(--sub-text);
        background: #fff; padding: 4px 8px; border-radius: 8px;
        z-index: 888;
    }
    .tab-bar {
        display: flex; gap: 8px; padding: 10px 12px;
        background: #fff; border-bottom: 1px solid var(--gray);
        overflow-x: auto; white-space: nowrap;
    }
    .tab {
        padding: 6px 12px; border-radius: 16px;
        font-size: 14px; background: var(--light); cursor: pointer;
    }
    .tab.active { background: var(--primary); color: #fff; }
    .sort-bar {
        display: flex; background: #fff;
        border-bottom: 1px solid var(--gray);
    }
    .sort-btn {
        flex: 1; padding: 10px 0; font-size: 14px;
        background: #fff; border: none; border-right: 1px solid var(--gray);
        cursor: pointer; color: var(--sub-text);
    }
    .sort-btn:last-child { border-right: none; }
    .sort-btn.active { background: var(--primary); color: #fff; }
    .sort-arrow { margin-left: 4px; }
    .container { padding: 8px; }
    .fund-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; overflow: hidden;
    }
    .fund-info {
        width: 90px; padding: 10px; border-right: 1px solid var(--gray);
        display: flex; flex-direction: column; gap: 6px;
    }
    .fund-name {
        font-size: 13px; background: var(--light); padding: 4px;
        border-radius: 4px; text-align: center;
    }
    .fund-code {
        font-size: 12px; color: var(--sub-text); text-align: center;
        cursor: pointer; padding: 2px 4px; border-radius: 4px; background: #f5f5f5;
    }
    .fund-btns { display: flex; flex-direction: column; gap: 4px; }
    .fund-btns button {
        border: none; border-radius: 4px; font-size: 12px;
        padding: 4px; cursor: pointer;
    }
    .btn-buy { background: var(--buy-bg); color: var(--buy); }
    .btn-sell { background: var(--sell-bg); color: var(--sell); }
    .data-box { flex: 1; overflow-x: auto; }
    .data-row {
        display: inline-flex; align-items: center; height: 100%;
        padding: 0 12px; gap: 16px;
    }
    .data-item {
        min-width: 60px; display: flex; flex-direction: column;
        align-items: center; gap: 4px; padding: 6px 0;
    }
    .data-label { font-size: 11px; color: var(--sub-text); }
    .data-value { font-size: 14px; font-weight: 600; }
    .text-red { color: var(--sell); }
    .text-green { color: var(--buy); }
    .text-gray { color: var(--gray-text); }
    .tip { font-size: 11px; text-align: center; line-height: 1.2; margin-top: 2px; }
    .tip-buy { color: var(--buy); }
    .tip-sell { color: var(--sell); }
    .tip-record { color: var(--primary); font-weight: 500; }
    .footer {
        position: fixed; bottom: 0; left: 0; right: 0; height: 48px;
        background: #fff; border-top: 1px solid var(--gray); display: flex; z-index: 999;
    }
    .footer button {
        flex: 1; height: 100%; border: none; background: #fff;
        font-size: 14px; color: var(--primary); cursor: pointer;
    }
    .mask {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5);
        display: none; align-items: center; justify-content: center;
        z-index: 9999;
    }
    .modal {
        background: #fff; width: 90%; max-width: 380px; border-radius: 16px; padding: 20px;
        display: flex; flex-direction: column; gap: 14px;
        max-height: 80vh; overflow-y: auto;
    }
    .modal-title { text-align: center; font-size: 16px; font-weight: 600; }
    .form-item {
        display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .form-item label { font-size: 14px; min-width: 130px; }
    .form-item input, .form-item select, .form-item textarea {
        flex: 1; border: 1px solid var(--gray); border-radius: 6px; padding: 6px 8px;
    }
    .form-text { width: 100%; height: 120px; resize: none; font-size: 12px; }
    .modal-btn {
        border: none; border-radius: 8px; padding: 8px 12px;
        font-size: 14px; cursor: pointer;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-default { background: var(--gray); }
    .btn-danger {
        background: var(--sell-bg); color: var(--sell);
        font-size: 12px; padding: 2px 6px; border: none; border-radius: 3px; cursor: pointer;
    }
    .list-box {
        max-height: 100px; overflow-y: auto;
        border: 1px solid var(--gray); border-radius: 6px; padding: 4px;
    }
    .list-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 4px 6px; font-size: 13px;
    }
    .switch {
        width: 40px; height: 20px; background: #ccc;
        border-radius: 10px; position: relative; cursor: pointer;
    }
    .switch::after {
        content: ''; position: absolute; width: 16px; height: 16px;
        background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s;
    }
    .switch.on { background: var(--primary); }
    .switch.on::after { left: 22px; }
    .loading {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #fff; padding: 12px 24px; border-radius: 8px;
        font-size: 14px; z-index: 99999; display: none;
    }
</style>
</head>
<body>
<div class="top-time" id="timeText"></div>
<div class="tab-bar" id="tabBar"></div>
<div class="sort-bar">
    <button class="sort-btn active" data-key="today">今日 <span class="sort-arrow">↓</span></button>
    <button class="sort-btn" data-key="3d">3日</button>
    <button class="sort-btn" data-key="7d">7日</button>
    <button class="sort-btn" data-key="30d">1月</button>
</div>
<div class="container" id="container"></div>
<div class="loading" id="loadingTip">加载中...</div>

<div class="footer">
    <button onclick="scrollToToday()">今日</button>
    <button onclick="refreshData()">刷新</button>
    <button onclick="openMoreSettings()">更多设置</button>
</div>

<!-- 更多设置 -->
<div class="mask" id="moreSettingsMask">
    <div class="modal">
        <div class="modal-title">更多设置</div>
        <button class="modal-btn btn-primary" onclick="openAddData()">添加数据</button>
        <button class="modal-btn btn-primary" onclick="openFundSettings()">基金涨跌幅设置</button>
        <button class="modal-btn btn-primary" onclick="openApiSettings()">接口设置</button>
        <button class="modal-btn btn-default" onclick="closeMoreSettings()">关闭</button>
    </div>
</div>

<!-- 基金设置 -->
<div class="mask" id="fundSettingsMask">
    <div class="modal">
        <div class="modal-title">基金涨跌幅设置</div>
        <div class="form-item">
            <label>展示历史天数</label>
            <input type="number" id="showDay" value="33">
        </div>
        <div class="form-item">
            <label>卖出阈值 %</label>
            <input type="number" step="0.01" id="sellLine" value="2">
        </div>
        <div class="form-item">
            <label>买入阈值 %</label>
            <input type="number" step="0.01" id="buyLine" value="2">
        </div>
        <div class="form-item">
            <label>多日涨幅提示</label>
            <div class="switch on" id="tipRise"></div>
        </div>
        <div class="form-item">
            <label>多日跌幅提示</label>
            <div class="switch on" id="tipFall"></div>
        </div>
        <div class="form-item">
            <label>定投阈值 %</label>
            <input type="number" step="0.01" id="investPercent" value="2">
        </div>
        <div class="form-item">
            <label>定投金额</label>
            <input type="number" id="investAmount" value="28">
        </div>
        <button class="modal-btn btn-primary" onclick="saveFundSettings()">保存</button>
        <button class="modal-btn btn-default" onclick="closeFundSettings()">关闭</button>
    </div>
</div>

<!-- 添加数据 -->
<div class="mask" id="addDataMask">
    <div class="modal">
        <div class="modal-title">添加数据</div>
        <div class="form-item">
            <label>输入板块名</label>
            <input type="text" id="newPlate" placeholder="板块名称">
        </div>
        <button class="modal-btn btn-primary" onclick="addPlate()">创建板块</button>
        <div class="list-box" id="plateList"></div>
        <div class="form-item">
            <label>选择板块</label>
            <select id="selPlate"></select>
        </div>
        <div class="list-box" id="fundList"></div>
        <div class="form-item">
            <label>基金代码</label>
            <input type="text" id="fundCode" placeholder="6位代码">
        </div>
        <button class="modal-btn btn-primary" onclick="addFund()">添加基金</button>
        <div class="form-item">
            <label>批量导入</label>
            <textarea id="batchText" placeholder="板块名+基金代码 换行"></textarea>
        </div>
        <button class="modal-btn btn-primary" onclick="batchImport()">批量导入</button>
        <button class="modal-btn btn-default" onclick="closeAddData()">关闭</button>
    </div>
</div>

<!-- 接口设置 -->
<div class="mask" id="apiSettingsMask">
    <div class="modal">
        <div class="modal-title">接口设置</div>
        <div class="form-item">
            <label>实时估值重试次数</label>
            <input type="number" id="retryGz" value="3" min="0">
        </div>
        <div class="form-item">
            <label>估值超时（秒）</label>
            <input type="number" id="timeoutGz" value="5" min="1">
        </div>
        <div class="form-item">
            <label>历史净值重试次数</label>
            <input type="number" id="retryLs" value="3" min="0">
        </div>
        <div style="height:1px;background:var(--gray);margin:8px 0"></div>
        <div class="form-item">
            <label>失败默认基金名</label>
            <input type="text" id="failName" value="获取失败">
        </div>
        <div class="form-item">
            <label>失败默认涨跌幅</label>
            <input type="number" id="failRate" value="9876543210">
        </div>
        <div style="height:1px;background:var(--gray);margin:8px 0"></div>
        <div class="form-item">
            <label>检测实时估值</label>
            <input type="text" id="testGzCode" placeholder="6位基金代码">
        </div>
        <button class="modal-btn btn-primary" onclick="testGzApi()">检测</button>
        <textarea class="form-text" id="testGzResult" readonly></textarea>
        <div class="form-item">
            <label>检测历史净值</label>
            <input type="text" id="testLsCode" placeholder="6位基金代码">
        </div>
        <button class="modal-btn btn-primary" onclick="testLsApi()">检测</button>
        <textarea class="form-text" id="testLsResult" readonly></textarea>
        <button class="modal-btn btn-primary" onclick="checkAndFixHistory()">补充历史净值</button>
        <button class="modal-btn btn-primary" onclick="saveApiAndFailSettings()">保存全部</button>
        <button class="modal-btn btn-default" onclick="closeApiSettings()">关闭</button>
    </div>
</div>

<script>
// ===================== 常量配置 =====================
const CONFIG = "FUND_CONFIG";
const PLATES = "FUND_PLATES";
const HISTORY_CACHE = "HISTORY_CACHE";
const FUND_RECORDS = "FUND_RECORDS";
const FAIL_SETTINGS = "FAIL_SETTINGS";
const API_SETTINGS = "API_SETTINGS";
const FIRST_INIT = "FUND_FIRST_INIT";

const DEFAULT_FAIL_VALUE = 9876543210;
const DEFAULT_FAIL_NAME = "获取失败";

const defaultConfig = {
    showDay: 33,
    sellLine: 2,
    buyLine: 2,
    tipRise: true,
    tipFall: true,
    investPercent: 2,
    investAmount: 28
};

const defaultApi = {
    retryGz: 3,
    timeoutGz: 5,
    retryLs: 3
};

const defaultFail = {
    name: DEFAULT_FAIL_NAME,
    rate: DEFAULT_FAIL_VALUE
};

// 全局状态
let fundTempData = { today: {}, history: [], loading: false };
let currentTab = "all";
let currentSort = "today";
let sortOrder = "desc";

// 首次初始化：强制写入默认值
function initDefaultCache() {
    if (localStorage.getItem(FIRST_INIT) !== "true") {
        setConfig(defaultConfig);
        setApi(defaultApi);
        setFailSettings(defaultFail);
        localStorage.setItem(FIRST_INIT, "true");
    }
}

// 读写缓存
function getConfig() { try { return JSON.parse(localStorage.getItem(CONFIG)) || defaultConfig; } catch { return defaultConfig; } }
function setConfig(c) { localStorage.setItem(CONFIG, JSON.stringify(c)); }
function getApi() { try { return JSON.parse(localStorage.getItem(API_SETTINGS)) || defaultApi; } catch { return defaultApi; } }
function setApi(a) { localStorage.setItem(API_SETTINGS, JSON.stringify(a)); }
function getPlates() { try { return JSON.parse(localStorage.getItem(PLATES)) || []; } catch { return []; } }
function setPlates(p) { localStorage.setItem(PLATES, JSON.stringify(p)); }
function getHistoryCache() { try { return JSON.parse(localStorage.getItem(HISTORY_CACHE)) || {}; } catch { return {}; } }
function setHistoryCache(c) { localStorage.setItem(HISTORY_CACHE, JSON.stringify(c)); }
function getFailSettings() { try { return JSON.parse(localStorage.getItem(FAIL_SETTINGS)) || defaultFail; } catch { return defaultFail; } }
function setFailSettings(f) { localStorage.setItem(FAIL_SETTINGS, JSON.stringify(f)); }
function getRecords() { try { return JSON.parse(localStorage.getItem(FUND_RECORDS)) || {}; } catch { return {}; } }
function saveRecord(code, date, type) {
    const r = getRecords(); if (!r[code]) r[code] = {};
    r[code][date] = type; localStorage.setItem(FUND_RECORDS, JSON.stringify(r));
}

// 工具
function getDateKey(n) {
    const d = new Date(); d.setDate(d.getDate() - n);
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), ds = String(d.getDate()).padStart(2,'0');
    return `${y}${m}${ds}`;
}
function getTodayDate() { return new Date().toISOString().split("T")[0]; }
function showLoading(t) { document.getElementById("loadingTip").innerText = t||"加载中..."; document.getElementById("loadingTip").style.display = "block"; }
function hideLoading() { document.getElementById("loadingTip").style.display = "none"; }
function removeScript(id) { const el = document.getElementById(id); if(el) el.remove(); }
async function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// 估值请求（简化，无冲突回调）
window.jsonpgz = function (res) {
    if (!res || !res.fundcode) return;
    const v = Number(res.gszzl || 0);
    const fail = getFailSettings();
    fundTempData.today[res.fundcode] = {
        val: v,
        text: v.toFixed(2) + "%",
        cls: v >= 0 ? "text-red" : "text-green",
        name: res.name || fail.name
    };
};

// 请求单个估值
async function loadGz(code) {
    return new Promise(resolve => {
        removeScript("gz_" + code);
        const s = document.createElement("script");
        s.id = "gz_" + code;
        s.src = `https://fundgz.1234567.com.cn/js/${code}.js?${Date.now()}`;
        s.onload = () => resolve(true);
        s.onerror = () => resolve(false);
        document.body.appendChild(s);
    });
}

// 估值重试+超时
async function getGzWithRetry(code) {
    const api = getApi();
    const maxRetry = api.retryGz;
    const timeout = api.timeoutGz * 1000;
    for (let i = 0; i <= maxRetry; i++) {
        try {
            const ok = await Promise.race([loadGz(code), new Promise(r => setTimeout(() => r(false), timeout))]);
            if (ok && fundTempData.today[code]) return true;
        } catch {}
        await delay(600);
    }
    return false;
}

// 历史净值请求
async function loadLs(code) {
    return new Promise(resolve => {
        removeScript("ls_" + code);
        const s = document.createElement("script");
        s.id = "ls_" + code;
        s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
        s.onload = () => { const f = window.fundinfo; delete window.fundinfo; resolve(f || null); };
        s.onerror = () => resolve(null);
        document.body.appendChild(s);
    });
}

// 批量获取今日估值
async function fetchToday(funds) {
    fundTempData.today = {};
    if (!funds.length) return;
    const fail = getFailSettings();
    for (const code of funds) {
        const ok = await getGzWithRetry(code);
        if (!ok || !fundTempData.today[code]) {
            fundTempData.today[code] = { val: fail.rate, text: "失败", cls: "text-gray", name: fail.name };
        }
    }
}

// 加载单只历史
async function loadOneHistory(code) {
    const cfg = getConfig();
    const days = cfg.showDay;
    const api = getApi();
    for (let i = 0; i <= api.retryLs; i++) {
        try {
            const fi = await loadLs(code);
            if (!fi || !fi.LSJZList) continue;
            const cache = getHistoryCache();
            fi.LSJZList.slice(0, days).forEach(item => {
                const v = Number(item.JZZZL || 0);
                const key = item.FSRQ.replace(/-/g, "");
                if (!cache[key]) cache[key] = {};
                cache[key][code] = { val: v, text: v.toFixed(2)+"%", cls: v>=0?"text-red":"text-green" };
            });
            setHistoryCache(cache);
            return true;
        } catch {}
        await delay(800);
    }
    return false;
}

// 批量历史
async function batchLoadHistory(codes) {
    let ok = 0, fail = 0;
    for (const c of codes) {
        const r = await loadOneHistory(c);
        r ? ok++ : fail++;
        await delay(500);
    }
    alert(`成功：${ok} 只，失败：${fail} 只`);
}

// 计算累计涨幅
function calcTotal(code, n) {
    const cache = getHistoryCache();
    const fail = getFailSettings();
    let sum = 0;
    for (let i = 1; i <= n; i++) {
        const val = cache[getDateKey(i)]?.[code]?.val;
        if (val != null && val !== fail.rate) sum += val;
    }
    return Math.round(sum * 100) / 100;
}

// 全局拉取
async function fetchAll() {
    if (fundTempData.loading) return;
    fundTempData.loading = true;
    showLoading();
    const cfg = getConfig();
    const all = [...new Set(getPlates().flatMap(p => p.funds).filter(Boolean))];
    await fetchToday(all);
    fundTempData.history = [];
    const cache = getHistoryCache();
    const show = Math.min(cfg.showDay, 60);
    for (let i = 1; i <= show; i++) fundTempData.history.push(cache[getDateKey(i)] || {});
    fundTempData.loading = false;
    hideLoading();
    render();
}

// 渲染页面
function render() {
    const cfg = getConfig();
    const fail = getFailSettings();
    const records = getRecords();
    const today = getTodayDate();
    const container = document.getElementById("container");
    let funds = currentTab === "all"
        ? [...new Set(getPlates().flatMap(p => p.funds).filter(Boolean))]
        : (getPlates()[currentTab]?.funds || []);

    if (funds.length === 0) {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:#999">暂无基金</div>`;
        return;
    }

    let list = funds.map(code => {
        const td = fundTempData.today[code] || { val: fail.rate, text: "失败", cls: "text-gray", name: fail.name };
        return {
            code, name: td.name, today: td.val,
            "3d": calcTotal(code, 3), "7d": calcTotal(code, 7), "30d": calcTotal(code, 30),
            todayData: td,
            todayOp: records[code]?.[today] || "",
            history: fundTempData.history.map(h => h[code] || { val: fail.rate, text: "无数据", cls: "text-gray" })
        };
    });

    list.sort((a, b) => sortOrder === "desc" ? (b[currentSort] ?? 0) - (a[currentSort] ?? 0) : (a[currentSort] ?? 0) - (b[currentSort] ?? 0));

    let html = "";
    list.forEach(item => {
        let opTip = "";
        if (item.todayOp === "buy") opTip = `<span class="tip tip-record">曾买入</span>`;
        if (item.todayOp === "sell") opTip = `<span class="tip tip-record">曾卖出</span>`;

        let tip = "";
        const val = item.today;
        if (val !== fail.rate) {
            if (val >= cfg.sellLine) tip = `<span class="tip tip-sell">卖(${cfg.sellLine}%)</span>`;
            else if (val <= -cfg.buyLine) tip = `<span class="tip tip-buy">买(${cfg.buyLine}%)</span>`;
        }

        html += `
        <div class="fund-card">
            <div class="fund-info">
                <div class="fund-name">${item.name}</div>
                <div class="fund-code" onclick="copy('${item.code}')">${item.code}</div>
                <div class="fund-btns">
                    <button class="btn-buy" onclick="buy('${item.code}')">买入</button>
                    <button class="btn-sell" onclick="sell('${item.code}')">卖出</button>
                </div>
            </div>
            <div class="data-box">
                <div class="data-row">
                    <div class="data-item">
                        <span class="data-label">今日</span>
                        <span class="${item.todayData.cls} data-value">${item.todayData.text}</span>
                        ${opTip}${tip}
                    </div>`;
        item.history.forEach((h, i) => {
            html += `
                    <div class="data-item">
                        <span class="data-label">T-${i+1}</span>
                        <span class="${h.cls} data-value">${h.text}</span>
                    </div>`;
        });
        html += `</div></div></div>`;
    });
    container.innerHTML = html;
}

// 买入/卖出/复制
function buy(code) { saveRecord(code, getTodayDate(), "buy"); alert("已记录买入"); render(); }
function sell(code) { saveRecord(code, getTodayDate(), "sell"); alert("已记录卖出"); render(); }
function copy(text) { navigator.clipboard.writeText(text).then(() => alert("已复制：" + text)).catch(() => alert("复制失败")); }

// 基础功能
function scrollToToday() { document.querySelectorAll(".data-box").forEach(b => b.scrollTo({ left: 0 })); }
function refreshData() { document.getElementById("timeText").innerText = new Date().toLocaleString(); fetchAll(); }
function renderTabs() {
    const bar = document.getElementById("tabBar");
    bar.innerHTML = `<div class="tab ${currentTab==='all'?'active':''}" onclick="switchTab('all')">全部</div>`;
    getPlates().forEach((p, i) => bar.innerHTML += `<div class="tab ${currentTab===i?'active':''}" onclick="switchTab(${i})">${p.name}</div>`);
}
function switchTab(k) { currentTab = k; renderTabs(); render(); }

// 排序
document.querySelectorAll(".sort-btn").forEach(btn => {
    btn.onclick = () => {
        const key = btn.dataset.key;
        if (currentSort === key) sortOrder = sortOrder === "desc" ? "asc" : "desc";
        else { currentSort = key; sortOrder = "desc"; }
        document.querySelectorAll(".sort-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        render();
    };
});

// 开关
function bindSwitch() { document.querySelectorAll(".switch").forEach(sw => sw.onclick = () => sw.classList.toggle("on")); }

// 弹窗
function openMoreSettings() { document.getElementById("moreSettingsMask").style.display = "flex"; }
function closeMoreSettings() { document.getElementById("moreSettingsMask").style.display = "none"; }

function openFundSettings() {
    const c = getConfig();
    document.getElementById("showDay").value = c.showDay;
    document.getElementById("sellLine").value = c.sellLine;
    document.getElementById("buyLine").value = c.buyLine;
    document.getElementById("tipRise").classList.toggle("on", c.tipRise);
    document.getElementById("tipFall").classList.toggle("on", c.tipFall);
    document.getElementById("investPercent").value = c.investPercent;
    document.getElementById("investAmount").value = c.investAmount;
    document.getElementById("fundSettingsMask").style.display = "flex";
}
function closeFundSettings() { document.getElementById("fundSettingsMask").style.display = "none"; }
function saveFundSettings() {
    setConfig({
        showDay: parseInt(document.getElementById("showDay").value) || 33,
        sellLine: parseFloat(document.getElementById("sellLine").value) || 2,
        buyLine: parseFloat(document.getElementById("buyLine").value) || 2,
        tipRise: document.getElementById("tipRise").classList.contains("on"),
        tipFall: document.getElementById("tipFall").classList.contains("on"),
        investPercent: parseFloat(document.getElementById("investPercent").value) || 2,
        investAmount: parseInt(document.getElementById("investAmount").value) || 28
    });
    closeFundSettings(); fetchAll();
}

function openApiSettings() {
    const a = getApi(); const f = getFailSettings();
    document.getElementById("retryGz").value = a.retryGz;
    document.getElementById("timeoutGz").value = a.timeoutGz;
    document.getElementById("retryLs").value = a.retryLs;
    document.getElementById("failName").value = f.name;
    document.getElementById("failRate").value = f.rate;
    document.getElementById("apiSettingsMask").style.display = "flex";
}
function closeApiSettings() { document.getElementById("apiSettingsMask").style.display = "none"; }
function saveApiAndFailSettings() {
    setApi({
        retryGz: parseInt(document.getElementById("retryGz").value) || 3,
        timeoutGz: parseInt(document.getElementById("timeoutGz").value) || 5,
        retryLs: parseInt(document.getElementById("retryLs").value) || 3
    });
    setFailSettings({
        name: document.getElementById("failName").value.trim() || DEFAULT_FAIL_NAME,
        rate: parseFloat(document.getElementById("failRate").value) || DEFAULT_FAIL_VALUE
    });
    closeApiSettings(); fetchAll();
}

async function checkAndFixHistory() {
    closeApiSettings(); showLoading("加载历史...");
    const all = [...new Set(getPlates().flatMap(p => p.funds).filter(Boolean))];
    await batchLoadHistory(all); hideLoading(); render();
}

// 接口测试
async function testGzApi() {
    const code = document.getElementById("testGzCode").value.trim();
    if (!/^\d{6}$/.test(code)) return alert("6位代码");
    showLoading("测试中...");
    fundTempData.today = {};
    await getGzWithRetry(code);
    hideLoading();
    document.getElementById("testGzResult").value = fundTempData.today[code] ? JSON.stringify(fundTempData.today[code], null, 2) : "失败";
}
async function testLsApi() {
    const code = document.getElementById("testLsCode").value.trim();
    if (!/^\d{6}$/.test(code)) return alert("6位代码");
    showLoading("测试中...");
    const res = await loadLs(code);
    hideLoading();
    document.getElementById("testLsResult").value = res ? JSON.stringify(res, null, 2) : "失败";
}

// 板块/基金管理
function openAddData() { renderPlateList(); document.getElementById("addDataMask").style.display = "flex"; }
function closeAddData() { document.getElementById("addDataMask").style.display = "none"; }
function renderPlateList() {
    const p = getPlates(); let html = "";
    p.forEach((item, i) => html += `<div class="list-item"><span>${item.name}（${item.funds.length}）</span><button class="btn-danger" onclick="delPlate(${i})">删</button></div>`);
    document.getElementById("plateList").innerHTML = html || "<div class='list-item'><span>暂无板块</span></div>";
    renderSelPlate();
}
function renderSelPlate() {
    const p = getPlates(); let html = `<option value="">--选择板块--</option>`;
    p.forEach((item, i) => html += `<option value="${i}">${item.name}</option>`);
    document.getElementById("selPlate").innerHTML = html;
    renderFundList();
}
function renderFundList() {
    const p = getPlates(); const idx = document.getElementById("selPlate").value;
    const box = document.getElementById("fundList");
    if (!idx || !p[idx]) { box.innerHTML = "<div class='list-item'><span>请选板块</span></div>"; return; }
    let html = "";
    p[idx].funds.forEach((c, i) => html += `<div class="list-item"><span>${c}</span><button class="btn-danger" onclick="delFund(${idx},${i})">删</button></div>`);
    box.innerHTML = html || "<div class='list-item'><span>暂无基金</span></div>";
}
function addPlate() {
    const name = document.getElementById("newPlate").value.trim();
    if (!name) return alert("请输入板块名");
    const p = getPlates(); if (p.some(x => x.name === name)) return alert("已存在");
    p.push({ name, funds: [] }); setPlates(p);
    document.getElementById("newPlate").value = ""; renderPlateList(); renderTabs();
}
function delPlate(i) { if (!confirm("确定删除？")) return; const p = getPlates(); p.splice(i, 1); setPlates(p); renderPlateList(); renderTabs(); fetchAll(); }
function addFund() {
    const idx = document.getElementById("selPlate").value;
    const code = document.getElementById("fundCode").value.trim();
    if (!idx) return alert("请选板块"); if (!/^\d{6}$/.test(code)) return alert("6位代码");
    const p = getPlates(); if (p[idx].funds.includes(code)) return alert("已添加");
    p[idx].funds.push(code); setPlates(p);
    document.getElementById("fundCode").value = ""; renderFundList(); fetchAll();
}
function delFund(pIdx, fIdx) { if (!confirm("确定删除？")) return; const p = getPlates(); p[pIdx].funds.splice(fIdx, 1); setPlates(p); renderFundList(); fetchAll(); }
function batchImport() {
    const text = document.getElementById("batchText").value.trim();
    if (!text) return alert("请输入内容");
    const lines = text.split("\n").map(x => x.trim()).filter(Boolean);
    const p = getPlates(); let cur = null;
    lines.forEach(line => {
        if (/^\d{6}$/.test(line)) { if (cur && !cur.funds.includes(line)) cur.funds.push(line); }
        else { let f = p.find(x => x.name === line); if (!f) { f = { name: line, funds: [] }; p.push(f); } cur = f; }
    });
    setPlates(p); closeAddData(); renderTabs(); fetchAll(); alert("导入完成");
}

// 初始化
window.onload = () => { initDefaultCache(); bindSwitch(); renderTabs(); refreshData(); };
</script>
</body>
</html>
