<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <title>基金行情</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }
        :root {
            --primary: #8AB4F8;
            --light: #f5f9ff;
            --gray: #e5e7eb;
            --text: #111827;
            --sub-text: #6b7280;
            --buy: #059669;
            --buy-bg: #ecfdf5;
            --sell: #dc2629;
            --sell-bg: #fee2e2;
            --invest: #8B5CF6;
            --invest-bg: #f5f3ff;
            --pink: rgba(255,228,235,0.6);
            --gray-text: #9ca3af;
        }
        body {
            background: var(--light);
            color: var(--text);
            padding-bottom: 50px;
        }
        .tab-bar {
            display: flex; gap: 8px; padding: 10px 12px;
            background: #fff; border-bottom: 1px solid var(--gray);
            overflow-x: auto; white-space: nowrap;
        }
        .tab {
            padding: 6px 12px; border-radius: 16px;
            font-size: 14px; background: var(--light); cursor: pointer;
        }
        .tab.active { background: var(--primary); color: #fff; }

        .sort-bar {
            display: flex;
            gap: 0;
            padding: 0;
            background: #fff;
            border-bottom: 1px solid var(--gray);
        }
        .sort-btn {
            flex: 1;
            padding: 10px 0;
            border-radius: 0;
            font-size: 14px;
            background: #fff;
            border: none;
            border-right: 1px solid var(--gray);
            cursor: pointer;
            color: var(--sub-text);
        }
        .sort-btn:last-child {
            border-right: none;
        }
        .sort-btn.active {
            background: var(--primary);
            color: #fff;
            border-right-color: var(--primary);
        }
        .sort-arrow { margin-left: 4px; }

        .data-tip {
            display: none;
        }

        .container { padding: 8px; }
        .fund-card {
            background: #fff; border-radius: 12px; margin-bottom: 8px;
            display: flex; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .fund-info {
            width: 90px; padding: 10px; border-right: 1px solid var(--gray);
            display: flex; flex-direction: column; gap: 6px;
        }
        .fund-name {
            font-size: 13px; background: var(--light); padding: 4px;
            border-radius: 4px; text-align: center;
        }
        .fund-code { font-size: 12px; color: var(--sub-text); text-align: center; }
        .fund-btns { display: flex; flex-direction: column; gap: 4px; }
        .fund-btns button {
            border: none; border-radius: 4px; font-size: 12px;
            padding: 4px; cursor: pointer;
        }
        .btn-buy { background: var(--buy-bg); color: var(--buy); }
        .btn-sell { background: var(--sell-bg); color: var(--sell); }
        .data-box { flex: 1; overflow-x: auto; }
        .data-row {
            display: inline-flex; align-items: center; height: 100%;
            padding: 0 12px; gap: 16px;
        }
        .data-item {
            min-width: 60px; display: flex; flex-direction: column;
            align-items: center; gap: 4px; padding: 6px 0; border-radius: 6px;
        }
        .data-label { font-size: 11px; color: var(--sub-text); }
        .data-value { font-size: 14px; font-weight: 600; }
        .text-red { color: var(--sell); }
        .text-green { color: var(--buy); }
        .text-gray { color: var(--gray-text); }
        .tip { font-size: 11px; text-align: center; line-height: 1.2; margin-top: 2px; }
        .tip-buy { color: var(--buy); }
        .tip-sell { color: var(--sell); }
        .tip-record { color: var(--primary); font-weight: 500; }
        .bg-sell { background: var(--sell-bg); }
        .bg-buy { background: var(--buy-bg); }

        .footer {
            position: fixed; bottom: 0; left: 0; right: 0; height: 48px;
            background: #fff; border-top: 1px solid var(--gray); display: flex; z-index: 999;
        }
        .footer button {
            flex: 1; height: 100%; border: none; background: none;
            font-size: 14px; color: var(--primary); cursor: pointer;
        }

        /* 弹窗层级：支持多层叠加 */
        .mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            display: none; align-items: center; justify-content: center;
        }
        /* 底层：更多设置 */
        #moreSettingsMask { z-index: 9999; }
        /* 中层：基金设置、添加数据 */
        #fundSettingsMask, #addDataMask { z-index: 10000; }
        /* 上层：接口设置、失败默认设置 */
        #apiSettingsMask, #failSettingsMask { z-index: 10001; }

        .modal {
            background: #fff; width: 88%; border-radius: 16px; padding: 24px;
            display: flex; flex-direction: column; gap: 16px;
        }
        .modal-title { text-align: center; font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .form-item {
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
        }
        .form-item label { font-size: 14px; width: 100px; }
        .form-item input, .form-item select, .form-item textarea {
            flex: 1; border: 1px solid var(--gray); border-radius: 6px;
            padding: 6px 8px; font-size: 14px;
        }
        .form-item textarea { min-height: 60px; resize: none; }
        .modal-btn {
            border: none; border-radius: 6px; padding: 8px;
            font-size: 14px; cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-default { background: var(--gray); color: var(--text); }
        .btn-danger {
            background: var(--sell-bg); color: var(--sell);
            font-size: 12px; padding: 2px 6px; border: none; border-radius: 3px; cursor: pointer;
        }
        .list-box {
            max-height: 100px; overflow-y: auto;
            border: 1px solid var(--gray); border-radius: 6px; padding: 4px;
        }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 4px 6px; font-size: 13px;
        }
        .switch {
            width: 40px; height: 20px; background: #ccc;
            border-radius: 10px; position: relative; cursor: pointer;
        }
        .switch::after {
            content: ''; position: absolute; width: 16px; height: 16px;
            background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s;
        }
        .switch.on { background: var(--primary); }
        .switch.on::after { left: 22px; }
        .loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); padding: 12px 24px; border-radius: 8px;
            font-size: 14px; color: var(--text); z-index: 99999; display: none;
        }
        .form-tip {
            font-size: 11px; color: var(--sub-text);
            margin-top: 4px; text-align: right;
        }
    </style>
</head>
<body>
    <div class="top-time" id="timeText"></div>
    <div class="tab-bar" id="tabBar"></div>
    <div class="sort-bar">
        <button class="sort-btn active" data-key="today">今日 <span class="sort-arrow">↓</span></button>
        <button class="sort-btn" data-key="3d">3日</button>
        <button class="sort-btn" data-key="7d">7日</button>
        <button class="sort-btn" data-key="30d">1月</button>
    </div>
    <div class="data-tip" id="dataTip"></div>
    <div class="container" id="container"></div>
    <div class="loading" id="loadingTip">加载中...</div>

    <div class="footer">
        <button onclick="scrollToToday()">今日</button>
        <button onclick="refreshData()">刷新</button>
        <button onclick="openMoreSettings()">更多设置</button>
    </div>

    <div class="mask" id="moreSettingsMask">
        <div class="modal">
            <div class="modal-title">更多设置</div>
            <button class="modal-btn btn-primary" onclick="openFundSettings()">基金涨跌幅设置</button>
            <button class="modal-btn btn-primary" onclick="openAddData()">添加数据</button>
            <button class="modal-btn btn-primary" onclick="openApiSettings()">接口设置</button>
            <button class="modal-btn btn-primary" onclick="openFailSettings()">失败默认设置</button>
            <button class="modal-btn btn-default" onclick="closeMoreSettings()">关闭</button>
        </div>
    </div>

    <div class="mask" id="fundSettingsMask">
        <div class="modal">
            <div class="modal-title">基金涨跌幅设置</div>
            <div class="form-item">
                <label>展示历史天数</label>
                <input type="number" id="showDay" value="3">
            </div>
            <div class="form-item">
                <label>卖出阈值 %</label>
                <input type="number" step="0.01" id="sellLine" value="0.1">
            </div>
            <div class="form-item">
                <label>买入阈值 %</label>
                <input type="number" step="0.01" id="buyLine" value="0.1">
            </div>
            <div class="form-item">
                <label>多日涨幅提示</label>
                <div class="switch" id="tipRise"></div>
            </div>
            <div class="form-item">
                <label>多日跌幅提示</label>
                <div class="switch" id="tipFall"></div>
            </div>
            <div class="form-item">
                <label>定投提醒</label>
                <div class="switch" id="tipInvest"></div>
            </div>
            <div class="form-item">
                <label>定投阈值 %</label>
                <input type="number" step="0.01" id="investPercent" value="2">
            </div>
            <div class="form-item">
                <label>定投金额</label>
                <input type="number" id="investAmount" value="999">
            </div>
            <button class="modal-btn btn-primary" onclick="saveFundSettings()">保存</button>
            <button class="modal-btn btn-default" onclick="closeFundSettings()">关闭</button>
        </div>
    </div>

    <div class="mask" id="addDataMask">
        <div class="modal">
            <div class="modal-title">添加数据</div>
            <div class="form-item">
                <label>输入板块名</label>
                <input type="text" id="newPlate" placeholder="板块名称">
            </div>
            <button class="modal-btn btn-primary" onclick="addPlate()">创建板块</button>
            <div class="list-box" id="plateList"></div>
            <div class="form-item">
                <label>选择板块</label>
                <select id="selPlate"></select>
            </div>
            <div class="list-box" id="fundList"></div>
            <div class="form-item">
                <label>基金代码</label>
                <input type="text" id="fundCode" placeholder="基金代码">
            </div>
            <button class="modal-btn btn-primary" onclick="addFund()">添加基金</button>
            <div class="form-item">
                <label>批量导入</label>
                <textarea id="batchText" placeholder="板块+代码 换行输入"></textarea>
            </div>
            <button class="modal-btn btn-primary" onclick="batchImport()">批量导入</button>
            <button class="modal-btn btn-default" onclick="closeAddData()">关闭</button>
        </div>
    </div>

    <div class="mask" id="apiSettingsMask">
        <div class="modal">
            <div class="modal-title">接口设置</div>
            <div class="form-item">
                <label>接口重试次数</label>
                <input type="number" id="retryCount" value="1" min="0">
            </div>
            <div class="form-tip">0=不重试</div>
            <button class="modal-btn btn-primary" onclick="saveApiSettings()">保存</button>
            <button class="modal-btn btn-default" onclick="closeApiSettings()">关闭</button>
        </div>
    </div>

    <div class="mask" id="failSettingsMask">
        <div class="modal">
            <div class="modal-title">失败默认设置</div>
            <div class="form-item">
                <label>失败基金名</label>
                <input type="text" id="failName" value="加载失败">
            </div>
            <div class="form-item">
                <label>失败涨跌幅</label>
                <input type="number" id="failRate" value="9999999">
            </div>
            <button class="modal-btn btn-primary" onclick="saveFailSettings()">保存</button>
            <button class="modal-btn btn-default" onclick="closeFailSettings()">关闭</button>
        </div>
    </div>

    <script>
        const CONFIG = "FUND_CONFIG";
        const PLATES = "FUND_PLATES";
        const HISTORY_CACHE = "HISTORY_CACHE";
        const FUND_RECORDS = "FUND_RECORDS";
        const FAIL_SETTINGS = "FAIL_SETTINGS";
        const FIRST_USE = "FUND_FIRST_USE";
        const FIXED_HISTORY_DAYS = 33;

        let fundTempData = { today: {}, history: [], loading: false };
        let currentTab = "all";
        let currentSort = "today";
        let sortOrder = "desc";

        const defaultConfig = {
            showDay: 3,
            sellLine: 0.1,
            buyLine: 0.1,
            tipRise: false,
            tipFall: false,
            tipInvest: false,
            investPercent: 2,
            investAmount: 999,
            retryCount: 1
        };

        const defaultFailSettings = {
            name: "加载失败",
            rate: 9999999
        };

        function showLoading(text) {
            document.getElementById("loadingTip").innerText = text || "加载中...";
            document.getElementById("loadingTip").style.display = "block";
        }
        function hideLoading() {
            document.getElementById("loadingTip").style.display = "none";
        }
        function getConfig() {
            try { return JSON.parse(localStorage.getItem(CONFIG)) || { ...defaultConfig }; }
            catch (e) { return { ...defaultConfig }; }
        }
        function setConfig(c) { localStorage.setItem(CONFIG, JSON.stringify(c)); }
        function getPlates() {
            try { return JSON.parse(localStorage.getItem(PLATES)) || []; }
            catch (e) { return []; }
        }
        function setPlates(p) { localStorage.setItem(PLATES, JSON.stringify(p)); }
        function getHistoryCache() {
            try { return JSON.parse(localStorage.getItem(HISTORY_CACHE)) || {}; }
            catch (e) { return {}; }
        }
        function setHistoryCache(c) { localStorage.setItem(HISTORY_CACHE, JSON.stringify(c)); }
        function getFailSettings() {
            try { return JSON.parse(localStorage.getItem(FAIL_SETTINGS)) || { ...defaultFailSettings }; }
            catch (e) { return { ...defaultFailSettings }; }
        }
        function setFailSettings(s) { localStorage.setItem(FAIL_SETTINGS, JSON.stringify(s)); }
        function isFirstUse() { return localStorage.getItem(FIRST_USE) !== "false"; }
        function markUsed() { localStorage.setItem(FIRST_USE, "false"); }
        function removeScript(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function getRecords() {
            try { return JSON.parse(localStorage.getItem(FUND_RECORDS)) || {}; }
            catch (e) { return {}; }
        }
        function saveRecord(code, date, type) {
            const r = getRecords();
            if (!r[code]) r[code] = {};
            r[code][date] = type;
            localStorage.setItem(FUND_RECORDS, JSON.stringify(r));
        }

        async function retryRequest(fn, maxRetry) {
            let cnt = 0;
            while (cnt <= maxRetry) {
                try {
                    const r = await fn();
                    if (r) return r;
                } catch (e) {}
                cnt++;
                await new Promise(r => setTimeout(r, 800));
            }
            return false;
        }

        window.jsonpgz = res => {
            if (!res || !res.fundcode) return;
            const v = Number(res.gszzl || 0);
            const name = res.name || getFailSettings().name;
            fundTempData.today[res.fundcode] = {
                val: v,
                text: v.toFixed(2) + "%",
                cls: v >= 0 ? "text-red" : "text-green",
                name: name,
                time: res.gztime
            };
        };

        function requestTodayData(code) {
            return new Promise(resolve => {
                removeScript("gz_" + code);
                const s = document.createElement("script");
                s.id = "gz_" + code;
                s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rtime=${Date.now()}`;
                s.onload = () => resolve(!!fundTempData.today[code]);
                s.onerror = () => resolve(false);
                document.body.appendChild(s);
            });
        }

        async function getRealTodayData(funds) {
            return new Promise(resolve => {
                fundTempData.today = {};
                if (funds.length === 0) return resolve();
                const cfg = getConfig();
                const fail = getFailSettings();
                let done = 0;
                funds.forEach(code => {
                    retryRequest(() => requestTodayData(code), cfg.retryCount).then(success => {
                        if (!success || !fundTempData.today[code]) {
                            fundTempData.today[code] = {
                                val: fail.rate,
                                text: fail.rate + "%",
                                cls: "text-gray",
                                name: fail.name
                            };
                        } else {
                            const now = new Date();
                            const todayStr = now.toISOString().split("T")[0];
                            if (now.getHours() >= 15) {
                                const cache = getHistoryCache();
                                if (!cache[1]) cache[1] = {};
                                cache[1][code] = {
                                    val: fundTempData.today[code].val,
                                    text: fundTempData.today[code].text,
                                    cls: fundTempData.today[code].cls,
                                    date: todayStr
                                };
                                setHistoryCache(cache);
                            }
                        }
                        done++;
                        if (done === funds.length) resolve();
                    });
                });
            });
        }

        async function supplementYesterdayData(funds) {
            const cache = getHistoryCache();
            const need = funds.filter(c => !cache[1] || !cache[1][c]);
            if (need.length === 0) return;
            await batchLoadHistory(need, 1);
        }

        async function batchLoadHistory(codes, days) {
            const cfg = getConfig();
            const batchSize = 3;
            const delay = 1500;
            let ok = 0, fail = 0;
            for (let i = 0; i < codes.length; i += batchSize) {
                const batch = codes.slice(i, i + batchSize);
                const res = await Promise.all(
                    batch.map(code => retryRequest(() => loadOneHistory(code, days), cfg.retryCount))
                );
                res.forEach(r => r ? ok++ : fail++);
                await new Promise(r => setTimeout(r, delay));
            }
            if (fail === 0) {
                alert(`✅ 历史数据补充完成\n成功：${ok} 只`);
            } else {
                alert(`⚠️ 历史数据补充完毕\n成功：${ok} 只\n失败：${fail} 只`);
            }
        }

        async function loadOneHistory(code, days) {
            return new Promise(resolve => {
                try {
                    const cache = getHistoryCache();
                    let full = true;
                    for (let d = 1; d <= days; d++) {
                        if (!cache[d] || !cache[d][code]) { full = false; break; }
                    }
                    if (full) return resolve(true);
                    removeScript(`ls_${code}`);
                    const s = document.createElement("script");
                    s.id = `ls_${code}`;
                    s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
                    s.onload = () => {
                        try {
                            const fi = window.fundinfo;
                            if (!fi || !fi.LSJZList || fi.LSJZList.length < 1) throw new Error();
                            const list = fi.LSJZList;
                            const cache = getHistoryCache();
                            for (let d = 1; d <= days && d <= list.length; d++) {
                                const item = list[d - 1];
                                const v = Number(item.JZZZL || 0);
                                if (!cache[d]) cache[d] = {};
                                cache[d][code] = {
                                    val: v,
                                    text: v.toFixed(2) + "%",
                                    cls: v >= 0 ? "text-red" : "text-green",
                                    date: item.FSRQ
                                };
                            }
                            setHistoryCache(cache);
                            resolve(true);
                        } catch (e) {
                            resolve(false);
                        } finally {
                            removeScript(s.id);
                            delete window.fundinfo;
                        }
                    };
                    s.onerror = () => resolve(false);
                    document.body.appendChild(s);
                } catch (e) {
                    resolve(false);
                }
            });
        }

        function calcTotalRate(code, n) {
            const c = getHistoryCache();
            let sum = 0;
            for (let i = 1; i <= n; i++) {
                const val = c[i]?.[code]?.val;
                sum += (val === undefined || val >= 9999999) ? 0 : val;
            }
            return Math.round(sum * 100) / 100;
        }

        async function fetchAllData(isFirst) {
            if (fundTempData.loading) return;
            fundTempData.loading = true;
            showLoading(isFirst ? "首次加载..." : "刷新中...");
            const cfg = getConfig();
            const plates = getPlates();
            const all = [...new Set(plates.flatMap(x => x.funds).filter(Boolean))];
            try {
                await getRealTodayData(all);
                await supplementYesterdayData(all);
                if (isFirst) {
                    await batchLoadHistory(all, 7);
                    await batchLoadHistory(all, FIXED_HISTORY_DAYS);
                    markUsed();
                }
                fundTempData.history = [];
                const cache = getHistoryCache();
                const show = Math.min(cfg.showDay, FIXED_HISTORY_DAYS);
                for (let i = 1; i <= show; i++) {
                    fundTempData.history.push(cache[i] || {});
                }
            } catch (e) {} finally {
                fundTempData.loading = false;
                hideLoading();
                render();
            }
        }

        function scrollToToday() {
            document.querySelectorAll(".data-box").forEach(b => b.scrollTo({ left: 0, behavior: "smooth" }));
        }

        function refreshData() {
            document.getElementById("timeText").innerText = "最后刷新：" + new Date().toLocaleString();
            fetchAllData();
        }

        function renderTabs() {
            const bar = document.getElementById("tabBar");
            bar.innerHTML = `<div class="tab ${currentTab === 'all' ? 'active' : ''}" onclick="switchTab('all')">全部基金</div>`;
            getPlates().forEach((p, i) => {
                bar.innerHTML += `<div class="tab ${currentTab === i ? 'active' : ''}" onclick="switchTab(${i})">${p.name}</div>`;
            });
        }
        function switchTab(k) {
            currentTab = k;
            renderTabs();
            render();
        }

        document.querySelectorAll(".sort-btn").forEach(btn => {
            btn.onclick = () => {
                if (currentSort === btn.dataset.key) {
                    sortOrder = sortOrder === "desc" ? "asc" : "desc";
                } else {
                    currentSort = btn.dataset.key;
                    sortOrder = "desc";
                }
                document.querySelectorAll(".sort-btn").forEach(b => {
                    b.classList.remove("active");
                    b.querySelector(".sort-arrow").innerText = "";
                });
                btn.classList.add("active");
                if (currentSort === "today") {
                    btn.querySelector(".sort-arrow").innerText = sortOrder === "desc" ? "↓" : "↑";
                }
                render();
            };
        });

        function render() {
            const cfg = getConfig();
            const container = document.getElementById("container");
            const plates = getPlates();
            const records = getRecords();
            const fail = getFailSettings();
            let funds = [];
            if (currentTab === "all") {
                funds = [...new Set(plates.flatMap(p => p.funds).filter(Boolean))];
            } else {
                funds = plates[currentTab]?.funds || [];
            }
            let list = funds.map(code => {
                const td = fundTempData.today[code] || { val: fail.rate, text: fail.rate + "%", cls: "text-gray", name: fail.name };
                const hist = fundTempData.history.map(h => {
                    const item = h[code];
                    if (!item) return { val: fail.rate, text: fail.rate + "%", cls: "text-gray", date: "" };
                    return item;
                });
                return {
                    code, name: td.name, today: td.val,
                    "3d": calcTotalRate(code, 3),
                    "7d": calcTotalRate(code, 7),
                    "30d": calcTotalRate(code, 30),
                    todayData: td, historyData: hist
                };
            });
            list.sort((a, b) => {
                const va = a[currentSort] || 0;
                const vb = b[currentSort] || 0;
                return sortOrder === "desc" ? vb - va : va - vb;
            });
            let html = "";
            list.forEach(item => {
                html += `
                <div class="fund-card">
                    <div class="fund-info">
                        <div class="fund-name">${item.name}</div>
                        <div class="fund-code">${item.code}</div>
                        <div class="fund-btns">
                            <button class="btn-buy" onclick="doBuy('${item.code}')">买入</button>
                            <button class="btn-sell" onclick="doSell('${item.code}')">卖出</button>
                        </div>
                    </div>
                    <div class="data-box">
                        <div class="data-row">
                            <div class="data-item" data-val="${item.today}">
                                <span class="data-label">今日</span>
                                <span class="${item.todayData.cls} data-value">${item.todayData.text}</span>
                            </div>`;
                item.historyData.forEach((h, i) => {
                    let t = h.text;
                    let cl = h.cls;
                    let tipHtml = "";
                    if (h.val === fail.rate) {
                        tipHtml = `<span class="tip">数据加载失败</span>`;
                    } else {
                        if (h.date) tipHtml += `<span class="tip">${h.date}</span>`;
                        const rec = records[item.code]?.[h.date];
                        if (rec === "buy") tipHtml += `<span class="tip tip-record">曾买入</span>`;
                        if (rec === "sell") tipHtml += `<span class="tip tip-record">曾卖出</span>`;
                    }
                    html += `
                            <div class="data-item">
                                <span class="data-label">T-${i+1}</span>
                                <span class="${cl} data-value">${t}</span>
                                ${tipHtml}
                            </div>`;
                });
                html += `</div></div></div>`;
            });
            container.innerHTML = html;
            renderTips();
        }

        function renderTips() {
            const cfg = getConfig();
            const fail = getFailSettings();
            document.querySelectorAll("[data-val]").forEach(el => {
                const v = parseFloat(el.dataset.val);
                el.querySelectorAll(".tip:not(.tip-record)").forEach(t => t.remove());
                el.classList.remove("bg-sell", "bg-buy");
                if (v === fail.rate) return;
                if (cfg.sellLine > 0 && v >= cfg.sellLine) {
                    const t = document.createElement("span");
                    t.className = "tip tip-sell";
                    t.innerText = `卖出(${cfg.sellLine}%)`;
                    el.appendChild(t);
                    el.classList.add("bg-sell");
                }
                if (cfg.buyLine > 0 && v <= -cfg.buyLine) {
                    const t = document.createElement("span");
                    t.className = "tip tip-buy";
                    t.innerText = `买入(${cfg.buyLine}%)`;
                    el.appendChild(t);
                    el.classList.add("bg-buy");
                }
            });
        }

        function doBuy(code) {
            const today = new Date().toISOString().split("T")[0];
            saveRecord(code, today, "buy");
            alert(`已记录【买入】${code}`);
            render();
        }
        function doSell(code) {
            const today = new Date().toISOString().split("T")[0];
            saveRecord(code, today, "sell");
            alert(`已记录【卖出】${code}`);
            render();
        }

        function bindSwitch() {
            document.querySelectorAll(".switch").forEach(sw => {
                sw.onclick = () => sw.classList.toggle("on");
            });
        }

        // ====================== 弹窗逻辑：支持多层叠加 ======================
        function openMoreSettings() {
            document.getElementById("moreSettingsMask").style.display = "flex";
        }
        function closeMoreSettings() {
            document.getElementById("moreSettingsMask").style.display = "none";
        }

        function openFundSettings() {
            document.getElementById("fundSettingsMask").style.display = "flex";
        }
        function closeFundSettings() {
            document.getElementById("fundSettingsMask").style.display = "none";
        }
        function saveFundSettings() {
            const c = {
                ...getConfig(),
                showDay: parseInt(document.getElementById("showDay").value) || 3,
                sellLine: parseFloat(document.getElementById("sellLine").value) || 0.1,
                buyLine: parseFloat(document.getElementById("buyLine").value) || 0.1,
                tipRise: document.getElementById("tipRise").classList.contains("on"),
                tipFall: document.getElementById("tipFall").classList.contains("on"),
                tipInvest: document.getElementById("tipInvest").classList.contains("on"),
                investPercent: parseFloat(document.getElementById("investPercent").value) || 2,
                investAmount: parseInt(document.getElementById("investAmount").value) || 999
            };
            setConfig(c);
            closeFundSettings();
            fetchAllData();
        }

        function openAddData() {
            renderPlateList();
            document.getElementById("addDataMask").style.display = "flex";
        }
        function closeAddData() {
            document.getElementById("addDataMask").style.display = "none";
        }

        function openApiSettings() {
            document.getElementById("retryCount").value = getConfig().retryCount;
            document.getElementById("apiSettingsMask").style.display = "flex";
        }
        function closeApiSettings() {
            document.getElementById("apiSettingsMask").style.display = "none";
        }
        function saveApiSettings() {
            const c = { ...getConfig(), retryCount: parseInt(document.getElementById("retryCount").value) || 0 };
            setConfig(c);
            closeApiSettings();
        }

        function openFailSettings() {
            const s = getFailSettings();
            document.getElementById("failName").value = s.name;
            document.getElementById("failRate").value = s.rate;
            document.getElementById("failSettingsMask").style.display = "flex";
        }
        function closeFailSettings() {
            document.getElementById("failSettingsMask").style.display = "none";
        }
        function saveFailSettings() {
            const s = {
                name: document.getElementById("failName").value || "加载失败",
                rate: parseFloat(document.getElementById("failRate").value) || 9999999
            };
            setFailSettings(s);
            closeFailSettings();
        }
        // ==================================================================

        function renderPlateList() {
            const p = getPlates();
            let html = "";
            p.forEach((item, i) => {
                html += `<div class="list-item"><span>${item.name}（${item.funds.length}）</span><button class="btn-danger" onclick="deletePlate(${i})">删</button></div>`;
            });
            document.getElementById("plateList").innerHTML = html || "<div class='list-item'><span>暂无板块</span></div>";
            renderSelectPlate();
        }
        function renderSelectPlate() {
            const p = getPlates();
            let html = `<option value="">--选择板块--</option>`;
            p.forEach((item, i) => html += `<option value="${i}">${item.name}</option>`);
            document.getElementById("selPlate").innerHTML = html;
            renderFundList();
        }
        function renderFundList() {
            const p = getPlates();
            const idx = document.getElementById("selPlate").value;
            const box = document.getElementById("fundList");
            if (!idx || !p[idx]) {
                box.innerHTML = "<div class='list-item'><span>请选板块</span></div>";
                return;
            }
            const funds = p[idx].funds;
            let html = "";
            funds.forEach((code, i) => {
                html += `<div class="list-item"><span>${code}</span><button class="btn-danger" onclick="deleteFund(${idx},${i})">删</button></div>`;
            });
            box.innerHTML = html || "<div class='list-item'><span>暂无基金</span></div>";
        }

        function addPlate() {
            const name = document.getElementById("newPlate").value.trim();
            if (!name) return alert("请输入板块名");
            const p = getPlates();
            if (p.some(x => x.name === name)) return alert("已存在");
            p.push({ name, funds: [] });
            setPlates(p);
            document.getElementById("newPlate").value = "";
            renderPlateList();
            renderTabs();
        }
        function deletePlate(i) {
            if (!confirm("确定删除？")) return;
            const p = getPlates();
            p.splice(i, 1);
            setPlates(p);
            renderPlateList();
            renderTabs();
            fetchAllData();
        }
        function addFund() {
            const idx = document.getElementById("selPlate").value;
            const code = document.getElementById("fundCode").value.trim();
            if (!idx) return alert("请选板块");
            if (!/^\d{6}$/.test(code)) return alert("6位代码");
            const p = getPlates();
            if (p[idx].funds.includes(code)) return alert("已存在");
            p[idx].funds.push(code);
            setPlates(p);
            document.getElementById("fundCode").value = "";
            renderFundList();
            fetchAllData();
        }
        function deleteFund(pIdx, fIdx) {
            if (!confirm("确定删除？")) return;
            const p = getPlates();
            p[pIdx].funds.splice(fIdx, 1);
            setPlates(p);
            renderFundList();
            fetchAllData();
        }
        function batchImport() {
            const text = document.getElementById("batchText").value.trim();
            if (!text) return alert("请输入内容");
            const lines = text.split("\n").map(x => x.trim()).filter(Boolean);
            const p = getPlates();
            let current = null;
            lines.forEach(line => {
                if (/^\d{6}$/.test(line)) {
                    if (current && !current.funds.includes(line)) current.funds.push(line);
                } else {
                    let find = p.find(x => x.name === line);
                    if (!find) {
                        find = { name: line, funds: [] };
                        p.push(find);
                    }
                    current = find;
                }
            });
            setPlates(p);
            closeAddData();
            renderTabs();
            fetchAllData();
            alert("导入完成");
        }

        window.onload = () => {
            bindSwitch();
            document.getElementById("selPlate").onchange = renderFundList;
            renderTabs();
            fetchAllData(isFirstUse());
        };
    </script>
</body>
</html>
